<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automated and general reader of Nonmem data • NMdata</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Automated and general reader of Nonmem data">
<meta property="og:description" content="NMdata">
<meta property="og:image" content="https://philipdelff.github.io/NMdata/reference/figures/NMdata_logo_v01.png">
<meta property="og:image:alt" content="Efficient data preparation, consistency-checking and post-processing in PK/PD modeling">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NMdata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.7.2.908</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/NMscanData.html">Automated and general reader of Nonmem data</a>
    </li>
    <li>
      <a href="../articles/DataCreate.html">Data creation tools</a>
    </li>
    <li>
      <a href="../articles/NMdata-FAQ.html">FAQ</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Manual</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://github.com/philipdelff/NMdata">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="NMscanData_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Automated and general reader of Nonmem data</h1>
            
      
      
      <div class="hidden name"><code>NMscanData.Rmd</code></div>

    </div>

    
    
<p>Built 2021-06-14 using NMdata 0.0.7.2.908.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Preparing data for analysis in Nonmem and reading the results back into <code>R</code> can be time consuming. After a Nonmem run, a few tables may have to be combined. Then we need character variables that are only available in the input data file. And maybe the events ignored by Nonmem (say, observations below quantification limit that we still need in further analysis and plotting).</p>
<p>This vignette focuses on how to use <code>NMdata</code> to automate what needs to be trivial: get a dataset out of a Nonmem run, including discarded columns and rows from the input data. In brevity, the most important steps are</p>
<ul>
<li>Read and combine output tables</li>
<li>If wanted, read input data and restore variables that were not output from the Nonmem model</li>
<li>If wanted, also restore rows from input data that were disregarded in Nonmem (e.g. observations or subjects that are not part of the analysis)</li>
</ul>
<p>In most cases, this is not too hard to do. But with the large degree of flexibility Nonmem offers, the code will likely have to be adjusted between models, and there are a lot of caveats to be aware of. The implementation in <code>NMdata</code> works for the vast majority of models and aims at preventing and checking for as many caveats as possible. It is fast and default argument values can be configured depending on your setup (data standards, directory structure and other preferences).</p>
<p>Like the rest of <code>NMdata</code>, this functionality assumes as little as possible about how you work. It assumes nothing about the Nonmem model itself and as little as possible about the organization of data and file paths/names. This makes it powerful for meta analyses, for reading a model developed by someone else - or one written by ourselves when we used to do things slightly differently. It will work out of the box in the vast majority of cases.</p>
<p>We start by attaching <code>NMdata</code>. I’m a <code>data.table</code> user and use that for a few postprocessing steps. You can just as well use base R or <code>dplyr</code> if you prefer. Then <code>ggplot2</code> for illustrations.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://philipdelff.github.io/NMdata">NMdata</a></span><span class="op">)</span>
<span class="co">#&gt; Welcome to NMdata. Best place to browse NMdata documentation is</span>
<span class="co">#&gt; https://philipdelff.github.io/NMdata</span>
<span class="co">## not necessary for NMdata to run, but we use thse in the examples</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>For the examples we will be using files that are available in the <code>NMdata</code> package. To type a little less, we use this shortcut function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">file.NMdata</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"examples/nonmem"</span>,<span class="va">...</span><span class="op">)</span>, package<span class="op">=</span><span class="st">"NMdata"</span><span class="op">)</span></code></pre></div>
<!-- For the purpose of this vignette we will configure `NMdata` not to check time -->
<!-- stamps of input control streams and input data against output control -->
<!-- streams. We need it because we cannot control -->
<!-- time stamps of the files in the distributed package. -->
</div>
<div id="get-started" class="section level2">
<h2 class="hasAnchor">
<a href="#get-started" class="anchor"></a>Get started</h2>
<p>Try <code>NMscanData</code> on any model:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="fu">file.NMdata</span><span class="op">(</span><span class="st">"xgxr017.lst"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Model:  xgxr017</span>
<span class="co">#&gt; Input and output data combined by translation of</span>
<span class="co">#&gt; Nonmem data filters (not recommended).</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Used tables, contents shown as used/total:</span>
<span class="co">#&gt;               file     rows columns     IDs</span>
<span class="co">#&gt;    xgxr017_res.txt  905/905   15/15 150/150</span>
<span class="co">#&gt;  xgxr4.csv (input) 905/1502   22/23 150/150</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Distribution of rows on event types in returned data:</span>
<span class="co">#&gt;  EVID Output</span>
<span class="co">#&gt;     0    755</span>
<span class="co">#&gt;     1    150</span></code></pre></div>
<p><code>NMscanData</code> tells that it has read a model called <code>xgxr017</code> and how output and input data were combined. We shall see how these properties can be modified in a bit. Then follows an overview of how much data is used from the data files that were read. It used</p>
<ul>
<li>one output data file (based on the <code>$TABLE</code> section(s) in the <code>.lst</code> file) from which it used all 905 rows and all 15 column, totalling 150 different values of <code>ID</code>.</li>
<li>the input file, but only 905 out of 1502 rows and 22 out of 23 columns. Input data did not contain any ID’s that weren’t used.</li>
</ul>
<p>In the resulting data, 755 out of the 905 rows are <code>EVID==0</code>, the remaining 150 rows are <code>EVID==1</code>.</p>
<p>Let’s take a quick look at key properties of the data that was returned. It’s a <code>data.frame</code> with the additional <code>NMdata</code> class (for now, we just use it as a <code>data.frame</code>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">res0</span><span class="op">)</span>
<span class="co">#&gt; [1] "NMdata"     "data.frame"</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">res0</span><span class="op">)</span>
<span class="co">#&gt; [1] 905  39</span></code></pre></div>
<p>The data used for the example is a PK single ascending dose data set, great thanks to the <a href="https://cran.r-project.org/web/packages/xgxr/index.html">xgxr</a> package authors.</p>
<p>The obtained dataset contains both model predictions (i.e. from output tables) and a character variable, <code>trtact</code> (i.e. from input data). To the <code>.lst</code> (output control stream) file path was supplied by us.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">res0</span>,n<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;   ID NOMTIME TIME EVID CMT AMT DV FLAG STUDY   TVKA  TVV2    TVCL    TVV3</span>
<span class="co">#&gt; 1 31       0    0    1   1   3  0    0     1 0.1812 0.042 0.72457 0.17848</span>
<span class="co">#&gt; 2 32       0    0    1   1   3  0    0     1 0.1812 0.042 0.72457 0.17848</span>
<span class="co">#&gt;       TVQ     KA    V2      CL      V3       Q IPRED PRED RES WRES BLQ CYCLE</span>
<span class="co">#&gt; 1 2307400 0.1812 0.042 0.72457 0.17848 2307400     0    0   0    0   0     1</span>
<span class="co">#&gt; 2 2307400 0.1812 0.042 0.72457 0.17848 2307400     0    0   0    0   0     1</span>
<span class="co">#&gt;   DOSE PART PROFDAY PROFTIME WEIGHTB   EFF0 EVENTU   NAME TIMEUNIT TRTACT</span>
<span class="co">#&gt; 1    3    1       1        0  87.031 56.461     mg Dosing    Hours   3 mg</span>
<span class="co">#&gt; 2    3    1       1        0 100.620 45.096     mg Dosing    Hours   3 mg</span>
<span class="co">#&gt;     flag trtact   model nmout</span>
<span class="co">#&gt; 1 Dosing   3 mg xgxr017  TRUE</span>
<span class="co">#&gt; 2 Dosing   3 mg xgxr017  TRUE</span></code></pre></div>
<p>You may have noticed that when reading the model, we were told that 37 columns were read while 39 columns are found in the result. The reason is the last two columns added by <code>NMscanData</code> called <code>model</code> and <code>nmout</code>. <code>model</code> obviously contains the name of the model which is by default derived from the list file name. See later in the “Recover rows” section what <code>nmout</code> represents.</p>
<div id="use-a-unique-row-identifier-and-get-your-preferred-data-class-back" class="section level3">
<h3 class="hasAnchor">
<a href="#use-a-unique-row-identifier-and-get-your-preferred-data-class-back" class="anchor"></a>Use a unique row identifier and get your preferred data class back</h3>
<p>Above, we were told that “Input and output data combined by translation of Nonmem data filters (not recommended).” Because of the very commonly used <code>ACCEPT</code> and <code>IGNORE</code> statements in Nonmem <code>$DATA</code> sections, the rows in output tables are often a subset of the input data rows. If no other information is available, <code>NMscanData</code> reads and interprets the <code>ACCEPT</code> or <code>IGNORE</code> statements and applies them to the input data before combining with the output data.</p>
<p>A more robust approach is using a unique row identifier in both input data and output data. <code>NMscanData</code> can use this for merging the data. This means that the <code>ACCEPT</code> or <code>IGNORE</code> are not interpreted at all. Even though <code>NMscanData</code> should work even without, it is always recommended to always include a unique row identifier in both input and output tables (in fact, we just need it in one full-length output table).</p>
<p>The following model happens to have such a unique row identifier in the column called <code>ROW</code>. The default <code>NMscanData</code> behavior is to use the row identifier if it can find it. The name of the column with the row identifier can be supplied using the <code>col.row</code> argument (and the default can be changed using the <code>NMdataConf</code> function). The default is to look for <code>ROW</code>.</p>
<p>All features shown below will work whether you supply <code>col.row</code> or not. We use <code>col.row</code> because it is more robust and because it allows us to easily trace a row in the analysis back to the source data. We are now told that the data was merged by <code>ROW</code> - that’s better.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="fu">file.NMdata</span><span class="op">(</span><span class="st">"xgxr003.lst"</span><span class="op">)</span>,as.fun<span class="op">=</span><span class="fu">tibble</span><span class="fu">::</span><span class="va"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">)</span>
<span class="co">#&gt; Model:  xgxr003 </span>
<span class="co">#&gt; Input and output data merged by: ROW </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Used tables, contents shown as used/total:</span>
<span class="co">#&gt;                  file     rows columns     IDs</span>
<span class="co">#&gt;       xgxr003_res.txt  905/905     7/7 150/150</span>
<span class="co">#&gt;  xgxr003_res_vols.txt  905/905     3/7 150/150</span>
<span class="co">#&gt;    xgxr003_res_fo.txt  150/150     1/2 150/150</span>
<span class="co">#&gt;     xgxr1.csv (input) 905/1502   21/24 150/150</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Distribution of rows on event types in returned data:</span>
<span class="co">#&gt;  EVID Output</span>
<span class="co">#&gt;     0    755</span>
<span class="co">#&gt;     1    150</span></code></pre></div>
<p>We also added the <code>as.fun</code> argument. the “<code>as.</code>” refers to <code>as_tibble</code>, <code>as.data.frame</code>, <code>as.data.table</code> etc. - a function applied to the data before it’s returned by <code>NMscanData</code> (or any other <code>NMdata</code> function). So now we have a <code>tibble</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">res0</span><span class="op">)</span>
<span class="co">#&gt; [1] "NMdata"     "tbl_df"     "tbl"        "data.frame"</span></code></pre></div>
<p>I happen to be a <code>data.table</code> user so I am more comfortable working that way. Instead of using the <code>as.fun</code> all the time, we will change the default behavior using the <code>NMdataConf</code> function. Because <code>NMdata</code> is implemented in <code>data.table</code> we don’t need to pass the <code><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">data.table::as.data.table</a></code> function but we can (better) use the string <code>"data.table"</code> (again, <code>data.table</code> is the exception - for anything else, please pass a function):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/NMdataConf.html">NMdataConf</a></span><span class="op">(</span>as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></code></pre></div>
<p>Notice, <code>NMdataConf</code> will set the default value for all <code>NMdata</code> functions that use that argument. So when setting <code>as.fun</code> this way, we will get the desired class returned from all data generating <code>NMdata</code> functions.</p>
<p>We don’t want the same information about the dimensions repeated, so we use the <code>quiet</code> argument this time.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="fu">file.NMdata</span><span class="op">(</span><span class="st">"xgxr003.lst"</span><span class="op">)</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>As expected we got a <code>data.table</code> this time:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">res1</span><span class="op">)</span>
<span class="co">#&gt; [1] "NMdata"     "data.table" "data.frame"</span></code></pre></div>
</div>
<div id="results" class="section level3">
<h3 class="hasAnchor">
<a href="#results" class="anchor"></a>Results</h3>
<p>Let’s have a quick look at the data we got back. The following is done with <code>data.table</code>. The comments in the code should make it clear what happens if you are not familiar with <code>data.table</code>. You can do this with <code><a href="https://rdrr.io/r/base/tapply.html">base::tapply</a></code>, <code><a href="https://rdrr.io/r/stats/aggregate.html">stats::aggregate</a></code>, a combination of <code>dplyr::group_by</code> and <code>dplyr::summarize</code>, or whatever you prefer.</p>
<p><code>gmPRED</code> is calculated for sample times only and represents the geometric mean of population prediction (<code>PRED</code>) by dose and nominal time.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## trtact is a character. Make it a factor with levels ordered by</span>
<span class="co">## numerical dose level. The := is a data.table assignment within</span>
<span class="co">## res3. In dplyr, you could use mutate.</span>
<span class="va">res1</span><span class="op">[</span>,<span class="va">trtact</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">trtact</span>,<span class="va">DOSE</span><span class="op">)</span><span class="op">]</span>
<span class="co">## Derive geometric mean pop predictions by treatment and nominal</span>
<span class="co">## sample time. In dplyr, use group_by, summarize, and ifelse?</span>
<span class="va">res1</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span>,<span class="va">gmPRED</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">PRED</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
     by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">trtact</span>,<span class="va">NOMTIME</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p><img src="NMscanData_files/figure-html/plotres1-1.png" width="672"></p>
<p>Notice, how little data is shown on the small doses. Remember, only 905 of the 1502 rows in the input data were used? Most of the rows excluded in the analysis are so due to observation being below the quantification limit (BLQ). The next section shows how to recover all the input data rows with <code>NMscanData</code>.</p>
</div>
</div>
<div id="more-options-and-features" class="section level2">
<h2 class="hasAnchor">
<a href="#more-options-and-features" class="anchor"></a>More options and features</h2>
<div id="recover-rows" class="section level3">
<h3 class="hasAnchor">
<a href="#recover-rows" class="anchor"></a>Recover rows</h3>
<p>We may want to include the input data that was ignored by Nonmem. Use <code>recover.rows=TRUE</code> to include all rows from input data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="fu">file.NMdata</span><span class="op">(</span><span class="st">"xgxr014.lst"</span><span class="op">)</span>,recover.rows<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Model:  xgxr014 </span>
<span class="co">#&gt; Input and output data merged by: ROW </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Used tables, contents shown as used/total:</span>
<span class="co">#&gt;               file      rows columns     IDs</span>
<span class="co">#&gt;    xgxr014_res.txt   905/905   12/12 150/150</span>
<span class="co">#&gt;  xgxr2.rds (input) 1502/1502   22/24 150/150</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Distribution of rows on event types in returned data:</span>
<span class="co">#&gt;  EVID Input only Output</span>
<span class="co">#&gt;     0        597    755</span>
<span class="co">#&gt;     1          0    150</span></code></pre></div>
<p>Besides the <code>model</code> column holding the model name, <code>NMscanData</code> creates one other column by default. <code>nmout</code> is a boolean column created by <code>NMscanData</code> expressing whether each row was in the output data (<code>nmout==TRUE</code>) or they were recovered from the input data (<code>nmout==FALSE</code>).</p>
<p>We recognize these numbers from the message from <code>NMscanData</code> - the number of rows in output (905) and number of rows from input only (597).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res2</span><span class="op">[</span>,<span class="va">.N</span>,by<span class="op">=</span><span class="va">nmout</span><span class="op">]</span>
<span class="co">#&gt;    nmout   N</span>
<span class="co">#&gt; 1:  TRUE 905</span>
<span class="co">#&gt; 2: FALSE 597</span></code></pre></div>
<p>We make use of the <code>nmout</code> column to only calculate <code>gmPRED</code> for observations (<code>EVID==0</code>) processed by Nonmem.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## add geometric mean pop predictions by treatment and nominal sample</span>
<span class="co">## time. Only use sample records.</span>
<span class="va">res2</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">&amp;</span><span class="va">nmout</span><span class="op">==</span><span class="cn">TRUE</span>,
     <span class="va">gmPRED</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">PRED</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
     by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">trtact</span>,<span class="va">NOMTIME</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p><img src="NMscanData_files/figure-html/plot-res2-1.png" width="672"></p>
<p>Obviously, we were lucky that meaningful values were assigned to <code>DV</code> for the BLQ and pre-dose samples in input data, so we in this case could easily plot all the data.</p>
</div>
<div id="combine-multiple-models" class="section level3">
<h3 class="hasAnchor">
<a href="#combine-multiple-models" class="anchor"></a>Combine multiple models</h3>
<p><code>NMscanData</code> by default adds a column called <code>model</code> for convenience when working with multiple models. You can specify both column name and content as arguments in <code>NMscanData</code>. You can also configure the default column name and the function that generates the column content by <code>NMdataConf</code>. If you don’t, the column will be called <code>model</code>, and the model name taken from the <code>lst</code> file name (say, <code>xgxr001</code>). In the following we use this to compare population predictions from two different models. We read them again just to show the use of the argument to name the models ourselves. Remember, we configure <code>NMdata</code>’s <code>as.fun</code> option so we are working with <code>data.table</code> and we easily stack with <code>rbind</code> (<code>rbind.data.table</code>) filling in <code>NA</code>’s. We add a couple of options to specify how input and output data are to be combined.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/NMdataConf.html">NMdataConf</a></span><span class="op">(</span>as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span>
<span class="fu"><a href="../reference/NMdataConf.html">NMdataConf</a></span><span class="op">(</span>col.row<span class="op">=</span><span class="st">"ROW"</span><span class="op">)</span>
<span class="fu"><a href="../reference/NMdataConf.html">NMdataConf</a></span><span class="op">(</span>merge.by.row<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## notice fill is an option to rbind with data.table</span>
<span class="va">res1.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr001.lst"</span>, package<span class="op">=</span><span class="st">"NMdata"</span><span class="op">)</span>,
                     quiet<span class="op">=</span><span class="cn">TRUE</span>,modelname<span class="op">=</span><span class="st">"Two compartments"</span><span class="op">)</span>
<span class="va">res2.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr014.lst"</span>, package<span class="op">=</span><span class="st">"NMdata"</span><span class="op">)</span>,
                     modelname<span class="op">=</span><span class="st">"One compartment"</span>,
                     quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">res.mult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span><span class="op">(</span><span class="va">res1.m</span>,<span class="va">res2.m</span>,fill<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="co">## Notice, the NMdata class disappeared</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">res.mult</span><span class="op">)</span>
<span class="co">#&gt; [1] "data.table" "data.frame"</span>
<span class="va">res.mult</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">&amp;</span><span class="va">nmout</span><span class="op">==</span><span class="cn">TRUE</span>,
         <span class="va">gmPRED</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">PRED</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
         by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">model</span>,<span class="va">trtact</span>,<span class="va">NOMTIME</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p><img src="NMscanData_files/figure-html/plot-resmult-1.png" width="672"></p>
</div>
<div id="preserve-all-input-data-properties---use-rds" class="section level3">
<h3 class="hasAnchor">
<a href="#preserve-all-input-data-properties---use-rds" class="anchor"></a>Preserve all input data properties - use <code>rds</code>
</h3>
<p>Return to the example above creating the dataset <code>dat2</code>. Notice in the list of tables in the message from <code>NMscanData</code>, that input data is a <code>.rds</code> file. This is why we could sort the plots correctly on the dose level without reordering the factor levels first.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">trtact</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; [1] "factor"</span>
<span class="va">res2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">trtact</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; [1] "Placebo" "3 mg"    "10 mg"   "30 mg"   "100 mg"  "300 mg"</span></code></pre></div>
<p>If the argument <code>use.rds</code> is <code>TRUE</code>, <code>NMscanData</code> will look for an rds file next to the input data file (which is a delimited text file) the exact same name as the text file except the extension must be <code>.rds</code> rather than say <code>.csv</code> (for Nonmem and <code>NMscanData</code>, the extension of the delimited text file doesn’t matter). If it finds the <code>rds</code> file, this will be used instead. No checks are done of whether the contents are similar in any way to the delimited text file which is ignored in this case.</p>
<p>There are three advantages of using <code>rds</code> files:</p>
<ul>
<li>All attributes are kept. This includes column classes and factor levels.</li>
<li>Reading speed may be improved (NMdata uses <code>fread</code> from <code>data.table</code> which is extremely fast for delimited files so in many cases this difference can be small).</li>
<li>File sizes are greatly reduced from text to <code>rds</code>. This can be a big advantage if you are transfering files or reading over a network connection. <code>NMdata</code> is generally very fast (thanks to <code>data.table</code>) so file/network access (I/O) is likely to be the main bottleneck.</li>
</ul>
<p>If you write Nonmem datasets with the <code><a href="../reference/NMwriteData.html">NMdata::NMwriteData</a></code>, you can get an <code>rds</code> file automatically, exactly where <code>NMscanData</code> will look for it. Creating datasets using <code>NMdata</code> is described in <a href="https://philipdelff.github.io/NMdata/articles/DataCreate.html">this vignette</a>.</p>
</div>
</div>
<div id="what-exactly-will-nmscandata-return" class="section level2">
<h2 class="hasAnchor">
<a href="#what-exactly-will-nmscandata-return" class="anchor"></a>What exactly will NMscanData return?</h2>
<p>So far, the merge has been very straightforward, but in many situations, choices are made by <code>NMscanData</code>. The following main principles are followed:</p>
<ul>
<li>Output data prevails over input data</li>
<li>Row-specific output data is preferred over ID-level (<code>FIRSTONLY</code> or <code>LASTONLY</code>) tables</li>
<li>Output tables are prioritized by their order of apperance</li>
<li>Input data is as defined in the <code>$INPUT</code> section in Nonmem. This includes renaming of columns while columns that are dropped in Nonmem (<code>DROP</code> or <code>SKIP</code>) are included by <code>NMscanData</code>. Columns that are not included in <code>$INPUT</code> are named as in the input data file.</li>
<li>If rows are being recovered from input data (the <code>recover.rows</code> argument), no information from output is merged onto these rows.</li>
<li>The primary aim is to return the output data. If input and output cannot be meaningfully combined (very rare), output will be returned.</li>
</ul>
<p>Notice that the summary text printed to the <code>R</code> terminal by <code>NMscanData</code> tells how many columns are included from the available tables. Also, within the resulting object, you can find a detailed table of all variables available, and whether they are included or not.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">res1.m</span><span class="op">)</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">variables</span>,topn<span class="op">=</span><span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; NULL</span></code></pre></div>
</div>
<div id="reading-data-with-automatically-combining-it---the-nmscadata-building-blocks" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-data-with-automatically-combining-it---the-nmscadata-building-blocks" class="anchor"></a>Reading data with automatically combining it - the <code>NMscaData</code> building blocks</h2>
<p>Each of the steps involved in reading and combining the data from a model run can be done separately.</p>
<p>The <code>lst</code> file was scanned for output tables, and they were all read (including interpreting the possible <code>firstonly</code> option). The input data has been used based on the <code>$DATA</code> and <code>$INPUT</code> sections of the control stream. The key steps in this process are available as independent functions.</p>
<ul>
<li><p><code>NMreadTab</code>: Read an Nonmem output table based on the path to the output table file.</p></li>
<li><p><code>NMscanTables</code>: Read all output data files defined in a Nonmem run. Return a list of tables (as data.frames or data.tables).</p></li>
<li><p><code>NMtransInput</code>: Read input data based on a Nonmem file. Data will be processed and named like the Nonmem model. <code>ACCEPT</code> and <code>IGNORE</code> filters can be applied as well. There are a few limitations to this functionality at this point. More about them below.</p></li>
</ul>
</div>
<div id="what-should-i-do-for-my-models-to-be-compatible-with-nmscandata" class="section level2">
<h2 class="hasAnchor">
<a href="#what-should-i-do-for-my-models-to-be-compatible-with-nmscandata" class="anchor"></a>What should I do for my models to be compatible with NMscanData?</h2>
<p>The answer to this should be as close to “nothing” as possible - that’s more or less the aim of the function. You just have to make sure that the information that you need is present in input data and output data. No need to output information that is unchanged from input, but make sure to output what you need (like <code>IPRED</code>, <code>CWRES</code>, <code>CL</code>, <code>ETA1</code> etc which cannot be found in input). Some of these values can be found from other files generated by Nonmem but notice: <code>NMscanData</code> uses only input and output data.</p>
<p>It is recommended to always use a unique row identifier in both input and output data. This is the most robust way to merge back with input data. In firstonly tables, include the subject ID. Again, everything will most likely work even if you don’t, I personally don’t like relying on “most likely” when I can just as well have robustness.</p>
</div>
<div id="limitations" class="section level2">
<h2 class="hasAnchor">
<a href="#limitations" class="anchor"></a>Limitations</h2>
<p>Even if there are a few limitations to what models <code>NMscanData</code> can handle, there is a good chance you will never run into any of them, as they are mostly quite rare. If you do, reach out to me, and we’ll figure it out.</p>
<div id="input-data-file-must-exist-and-be-unmodified-since-model-run" class="section level3">
<h3 class="hasAnchor">
<a href="#input-data-file-must-exist-and-be-unmodified-since-model-run" class="anchor"></a>Input data file must exist and be unmodified since model run</h3>
<p>If merging with input data, the input data must be available as was when the model was run. If you want to avoid this potential issue, Nonmem can be run in a wrapper script that either copies the input data, or runs <code>NMscanData</code> and saves the output in a compressed file format (like <code>rds</code> or <code>zip</code>).</p>
</div>
<div id="not-all-data-filter-statements-implemented" class="section level3">
<h3 class="hasAnchor">
<a href="#not-all-data-filter-statements-implemented" class="anchor"></a>Not all data filter statements implemented</h3>
<p>Nested <code>ACCEPT</code> and <code>IGNORE</code> statements are not supported at this point. The resulting number of rows after applying filters is checked against row-level output table dimensions (if any available). In other words, you have to be unlucky to run into trouble without an error. But it is always recommended to use a unique row identifier in both input and output tables in order to avoid relying on interpretation of Nonmem code.</p>
<p>The <code>RECORDS</code> and <code>NULL</code> options in <code>$DATA</code> are not implemented. If using <code>RECORDS</code>, please use the <code>col.row</code> option to merge by a unique row identifier.</p>
</div>
<div id="character-time-variables-not-interpreted" class="section level3">
<h3 class="hasAnchor">
<a href="#character-time-variables-not-interpreted" class="anchor"></a>Character time variables not interpreted</h3>
<p>Nonmem supports a clocktime input format for a column called TIME in input data. Based on a day counter and a character (“00:00”) clock format, Nonmem (or rather, <code>NM-TRAN</code>) can calculate the individual time since first record. This behaviour is not mimicked by NMscanData, and the only ways to get TIME in this case are to either include it in an output <code>TABLE</code> or to code the translation yourself after calling <code>NMscanData</code>. Of course, this is on the todo list.</p>
</div>
<div id="some-table-options-not-supported" class="section level3">
<h3 class="hasAnchor">
<a href="#some-table-options-not-supported" class="anchor"></a>Some TABLE options not supported</h3>
<p>For now, only output tables returning either all rows or one row per subject can be merged with input. Tables written with options like <code>FIRSTLASTONLY</code> (two rows per subject) and <code>OBSONLY</code> are disregarded with a warning (you can read them with <code>NMscanTables</code>). <code>LASTONLY</code> is treated like <code>FIRSTONLY</code>, i.e. as ID-level information if not available elsewhere.</p>
</div>
</div>
<div id="custom-naming-of-input-and-output-control-streams" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-naming-of-input-and-output-control-streams" class="anchor"></a>Custom naming of input and output control streams</h2>
<p>By default, <code>NMscanData</code> expects a <a href="https://uupharmacometrics.github.io/PsN/">PSN</a>-style naming of input and output control streams. This means that if the input control stream is called <code>model.mod</code>, the returned control stream is called <code>model.lst</code>. If you use a different setup, you can use the <code>file.mod</code> argument. Do one of the following if needed:</p>
<ul>
<li>Explicitly give the path to the input control stream or</li>
<li>Pass a function that translates from the output control stream to the input. Example if the input is called <code>input.txt</code> and the output is called <code>output.txt</code>:</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out2in</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">dirname</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span>,<span class="st">"input.txt"</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="st">"path/to/output.txt"</span>,file.mod<span class="op">=</span><span class="va">out2in</span><span class="op">)</span></code></pre></div>
<p>You can use <code>NMdataConf</code> to configure the default behaviour to match your setup:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/NMdataConf.html">NMdataConf</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">out2in</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
