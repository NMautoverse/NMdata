<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Preparation Tools • NMdata</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Data Preparation Tools">
<meta property="og:description" content="NMdata">
<meta property="og:image" content="https://philipdelff.github.io/NMdata/reference/figures/apple-touch-icon-180x180.png">
<meta property="og:image:alt" content="Efficient data preparation, consistency-checking and post-processing in PK/PD modeling">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NMdata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.5.902</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://htmlpreview.github.io/?https://github.com/philipdelff/NMdata/blob/master/vignettes/NMdata-cheat.html" class="external-link">Cheat Sheet</a>
    </li>
    <li>
      <a href="../articles/NMscanData.html">NMscanData: find and combine all output and input data</a>
    </li>
    <li>
      <a href="../articles/DataPrepare.html">Data Preparation Tools</a>
    </li>
    <li>
      <a href="../articles/NMdata-FAQ.html">FAQ</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li>
  <a href="https://github.com/philipdelff/NMdata/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/philipdelff/NMdata/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Data Preparation Tools</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMdata/blob/HEAD/vignettes/DataPrepare.Rmd" class="external-link"><code>vignettes/DataPrepare.Rmd</code></a></small>
      <div class="hidden name"><code>DataPrepare.Rmd</code></div>

    </div>

    
    
<p>Built 2024-03-18 using NMdata 0.1.5.902.</p>
<p>This vignette is still under development. Please make sure to see
latest version available <a href="https://philipdelff.github.io/NMdata/">here</a>.</p>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This vignettes aims at enabling you at</p>
<ul>
<li><p>Using NMdata’s data preparation tools to assist building your
data set</p></li>
<li><p>Using <code>mergeCheck</code> to automatically check merge
results, ensuring rows do not get lost or duplicated</p></li>
<li><p>Assigning exclusion flags and obtain a table summary counting
data exclusions from source data to analysis data set</p></li>
<li><p>Easily and consistently order data columns using
<code>NMorderColumns</code></p></li>
<li><p>Using <code>NMcheckData</code> to perform a extensive data check
before exporting for NONMEM</p></li>
<li><p>Writing the prepared data to file ensuring compatibility with
NONMEM and for post-processing in R using
<code>NMwriteData</code></p></li>
<li><p>Updating multiple NONMEM control streams to read the updated data
file using one simple call of the <code>NMwriteSection</code>
function</p></li>
</ul>
<p>Only basic R knowledge should be required to follow the
instructions.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Getting data ready for modeling is a crucial and often underestimated
task. Mistakes during the process of combining data sets, defining time
variables etc. can lead to difficulties during modeling, need for
revisiting data set preparation, and in worst case wasted time working
with an erroneos data set. Avoiding those mistakes by integrating checks
into the data preparation process is a key element in an efficient and
reliable data preparation work flow.</p>
<p>Furthermore, NONMEM has a number of restrictions on the format of the
input data, and problems with the data set is a common reason for NONMEM
not to behave as expected. When this happens, debugging can be
time-consuming. <code>NMdata</code> includes some simple functions to
prevent these situations.</p>
<p>This vignette uses <code>data.table</code> syntax for the little bit
of data manipulation performed. However, you don’t need to use
data.table <em>at all</em> to use these or any tool in
<code>NMdata</code>. The data set is a <code>data.table</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/data/xgxr2.rds"</span>, package <span class="op">=</span> <span class="st">"NMdata"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "data.table" "data.frame"</span></span></code></pre></div>
<p>If you are not familiar with <code>data.table</code>, you can still
keep reading this vignette and learn what <code>NMdata</code> can do.
<code>data.table</code> is a powerful enhancement to the
<code>data.frame</code> class, and the syntax is a little different from
<code>data.frame</code>. The few places where this affects the examples
provided here, explanations will be given. You can replace all use of
<code>data.table</code> in this vignette with base R functions,
tidyverse functions or whatever you prefer.</p>
</div>
<div class="section level2">
<h2 id="data-assembly">Data assembly<a class="anchor" aria-label="anchor" href="#data-assembly"></a>
</h2>
<div class="section level3">
<h3 id="compare-presence-and-class-of-columns-across-data-sets">Compare presence and class of columns across data sets<a class="anchor" aria-label="anchor" href="#compare-presence-and-class-of-columns-across-data-sets"></a>
</h3>
<p>When stacking (<code>rbind</code>) and merging, it is most often
necessary to check if two or more data sets are compatible for the
operation. <code>compareCols</code> compares columns across two or more
data sets.</p>
<p>To illustrate the output of <code>compareCols</code>, a slightly
modified version of the <code>pk</code> dataset has been created. One
column (<code>CYCLE</code>) has been removed, and <code>AMT</code> has
been re-coded to character. <code>compareCols</code> tells us about
exactly these two differences:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compareCols.html">compareCols</a></span><span class="op">(</span><span class="va">pk</span>, <span class="va">pk.reduced</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dimensions:</span></span>
<span><span class="co">#&gt;          data nrows ncols</span></span>
<span><span class="co">#&gt;        &lt;char&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:         pk  1502    24</span></span>
<span><span class="co">#&gt; 2: pk.reduced   751    23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns that differ:</span></span>
<span><span class="co">#&gt;    column      pk pk.reduced</span></span>
<span><span class="co">#&gt;    &lt;char&gt;  &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:  CYCLE integer       &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:    AMT integer  character</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns where no differences were found: BLQ, CMT, DOSE, DV, EVENTU, EVID,</span></span>
<span><span class="co">#&gt; FLAG, ID, NAME, NOMTIME, PART, PROFDAY, PROFTIME, ROW, STUDY, TIME, TIMEUNIT,</span></span>
<span><span class="co">#&gt; TRTACT, WEIGHTB, eff0, flag, trtact.</span></span></code></pre></div>
<p>Before merging or stacking, we may want to re-code <code>AMT</code>
in one of the datasets to get the class we need, and decide what to do
about the <code>CYCLE</code> column which is missing in one of the
datasets (add information or fill with <code>NA</code>?).</p>
<p>When stacking data sets we often know what columns we are looking to
obtain in the final data. We may already have defined that early in our
data preparation script, and <code>compareCols</code> can use this to
highlight these columns. <code>cc</code> is a shorthand function to
create character vectors without quoting the elements.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">special.columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cc.html">cc</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, <span class="va">CYCLE</span>, <span class="va">STUDY</span>, <span class="va">BW</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/compareCols.html">compareCols</a></span><span class="op">(</span><span class="va">pk</span>, <span class="va">pk.reduced</span>, cols.wanted <span class="op">=</span> <span class="va">special.columns</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dimensions:</span></span>
<span><span class="co">#&gt;          data nrows ncols</span></span>
<span><span class="co">#&gt;        &lt;char&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:         pk  1502    24</span></span>
<span><span class="co">#&gt; 2: pk.reduced   751    23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns that differ:</span></span>
<span><span class="co">#&gt;    column      pk pk.reduced</span></span>
<span><span class="co">#&gt;    &lt;char&gt;  &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:    *ID integer    integer</span></span>
<span><span class="co">#&gt; 2:  *TIME numeric    numeric</span></span>
<span><span class="co">#&gt; 3: *CYCLE integer       &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4: *STUDY integer    integer</span></span>
<span><span class="co">#&gt; 5:    *BW    &lt;NA&gt;       &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:    AMT integer  character</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns where no differences were found: BLQ, CMT, DOSE, DV, EVENTU, EVID,</span></span>
<span><span class="co">#&gt; FLAG, *ID, NAME, NOMTIME, PART, PROFDAY, PROFTIME, ROW, *STUDY, *TIME,</span></span>
<span><span class="co">#&gt; TIMEUNIT, TRTACT, WEIGHTB, eff0, flag, trtact.</span></span></code></pre></div>
<p>In this case, we may want to add <code>diff.only=FALSE</code> to see
if other columns could hold the information we are missing for
<code>BW</code> and <code>CYCLE</code>.</p>
</div>
<div class="section level3">
<h3 id="rename-columns-based-on-contents">Rename columns based on contents<a class="anchor" aria-label="anchor" href="#rename-columns-based-on-contents"></a>
</h3>
<p>The model estimation step is heavily dependent (and in NONMEM almost
entirely based) on numeric data values. The source data will often
contain character variables, i.e. columns with non-numeric data
values.</p>
<p>If the column names reflect whether the values are numeric,
double-checking can be avoided. <code>renameByContents</code> renames
columns if a function of their contents returns <code>TRUE</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk.renamed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/renameByContents.html">renameByContents</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pktmp</span>, fun.test <span class="op">=</span> <span class="va">NMisNumeric</span>,</span>
<span>    fun.rename <span class="op">=</span> <span class="va">tolower</span>, invert.test <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We make use of the function <code>NMisNumeric</code> which tests if
NONMEM can interpret the contents as numeric. If say the subject ID is
of character class, it can be valid to NONMEM. Subject ID
<code>"1039"</code> will be a numeric in NONMEM, <code>"1-039"</code>
will not. <code>NMisNumeric</code> will return <code>TRUE</code> if and
only if all elements are either missing or interpretable as numeric. We
invert the condition (<code>invert.test=TRUE</code>), and <em>the
names</em> of the columns that NONMEM cannot interpret as numeric become
lowercase. We use <code>compareCols</code> to illustrate that three
columns were renamed:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compareCols.html">compareCols</a></span><span class="op">(</span><span class="va">pktmp</span>, <span class="va">pk.renamed</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dimensions:</span></span>
<span><span class="co">#&gt;          data nrows ncols</span></span>
<span><span class="co">#&gt;        &lt;char&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:      pktmp  1502    23</span></span>
<span><span class="co">#&gt; 2: pk.renamed  1502    23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns that differ:</span></span>
<span><span class="co">#&gt;      column     pktmp pk.renamed</span></span>
<span><span class="co">#&gt;      &lt;char&gt;    &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:   EVENTU character       &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:     NAME character       &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3: TIMEUNIT character       &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4:   eventu      &lt;NA&gt;  character</span></span>
<span><span class="co">#&gt; 5:     name      &lt;NA&gt;  character</span></span>
<span><span class="co">#&gt; 6: timeunit      &lt;NA&gt;  character</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns where no differences were found: AMT, BLQ, CMT, CYCLE, DOSE, DV, EVID,</span></span>
<span><span class="co">#&gt; FLAG, ID, NOMTIME, PART, PROFDAY, PROFTIME, ROW, STUDY, TIME, WEIGHTB, eff0,</span></span>
<span><span class="co">#&gt; flag, trtact.</span></span></code></pre></div>
<p>We can now easily see that if we wish to include the information
contained in <code>eventu</code>, <code>pktmp</code>, and
<code>pk.renamed</code>, we have to modify or translate their contents
first.</p>
</div>
<div class="section level3">
<h3 id="automated-checks-of-merge-results">Automated checks of merge results<a class="anchor" aria-label="anchor" href="#automated-checks-of-merge-results"></a>
</h3>
<p>Merge or join operations are a very powerful data preparation tool.
But they are also a very common source of bugs. Most of us know too well
how merges can leave us with unexpected rows or make rows disappear.
However, most often we can impose restrictions on the merge operation
that allows for automated validation of the results.</p>
<p>Imagine the very common example that we have a longitudinal PK data
set (called <code>pk</code>), and we want to add subject-level
covariates from a secondary data set (<code>dt.cov</code>). We want to
merge by <code>ID</code>, and all we can allow to happen is columns to
be added to <code>pk</code> from <code>dt.cov</code>. If rows disappear
or get repeated, or if columns get renamed, it’s unintended and should
return an error. That is what <code>mergeCheck</code> is for.</p>
<p>Often people check the dimensions of the result to make sure nothing
unintended happened. The following example shows that this is not
enough, and that <code>mergeCheck</code> works differently. After
merging the two data sets the check of the dimensions raises no alarm -
the number of rows is unchanged from <code>pk</code> to
<code>pk2</code>, and one of two columns in <code>dt.cov</code> was
added. <code>dims</code> is just a <code>dim</code>-like function that
can compare multiple data sets - handy for interactive analysis.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">pk</span>, <span class="va">dt.cov</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dims.html">dims</a></span><span class="op">(</span><span class="va">pk</span>, <span class="va">dt.cov</span>, <span class="va">pk2</span><span class="op">)</span></span>
<span><span class="co">#&gt;      data nrows ncols</span></span>
<span><span class="co">#&gt;    &lt;char&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:     pk  1502    24</span></span>
<span><span class="co">#&gt; 2: dt.cov   150     2</span></span>
<span><span class="co">#&gt; 3:    pk2  1502    25</span></span></code></pre></div>
<p>What we didn’t realize is that we now have twice as many rows for
subject 31.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="fl">31</span>, <span class="va">.N</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="va">pk2</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="fl">31</span>, <span class="va">.N</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 20</span></span></code></pre></div>
<p>If we instead use <code>mergeCheck</code>, we get an error. This is
because <code>mergeCheck</code> compares the actual rows going in and
out of the merge and not just the dimensions.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mergeCheck.html">mergeCheck</a></span><span class="op">(</span><span class="va">pk</span>, <span class="va">dt.cov</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows disappeared during merge.</span></span>
<span><span class="co">#&gt; Rows duplicated during merge.</span></span>
<span><span class="co">#&gt; Overview of dimensions of input and output data:</span></span>
<span><span class="co">#&gt;    nrows ncols</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:  1502    24</span></span>
<span><span class="co">#&gt; 2:   150     2</span></span>
<span><span class="co">#&gt; 3:  1502    25</span></span>
<span><span class="co">#&gt; Overview of values of by where number of rows in x changes:</span></span>
<span><span class="co">#&gt; Key: &lt;ID&gt;</span></span>
<span><span class="co">#&gt;       ID   N.x N.result</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;int&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    31    10       20</span></span>
<span><span class="co">#&gt; 2:   180    10        0</span></span>
<span><span class="co">#&gt; Error in mergeCheck(pk, dt.cov, by = "ID"): Merge added and/or removed rows.</span></span></code></pre></div>
<p>Notice that <code>mergeCheck</code> tells us for which values of
<code>ID</code> (the <code>by</code> argument which can be of length
&gt;1) the input and output differ so we can quickly look into the data
sets and make a decision how we want to handle this. In this case we
discard the covariate value for subject 31 and use
<code>all.x=TRUE</code> argument to get <code>NA</code> for subjects 31
and 180:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt.cov2</span> <span class="op">&lt;-</span> <span class="va">dt.cov</span><span class="op">[</span><span class="va">ID</span> <span class="op">!=</span> <span class="fl">31</span><span class="op">]</span></span>
<span><span class="va">pk2.check</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mergeCheck.html">mergeCheck</a></span><span class="op">(</span><span class="va">pk</span>, <span class="va">dt.cov2</span>, by <span class="op">=</span> <span class="st">"ID"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Column(s) added: COV</span></span></code></pre></div>
<p>To ensure the consistency of rows before and after the merge, you
could use <code>merge(...,all.x=TRUE)</code> and then check dimensions
before and after (yes, both <code>all.x=TRUE</code> and the dimension
check are necessary). This is not needed if you use
<code>mergeCheck</code>.</p>
<p><code>mergeCheck</code> does not try to reimplement merging. Under
the hood, the merge is performed by
<code><a href="https://rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">data.table::merge.data.table</a></code> to which most arguments are
passed. What <code>mergeCheck</code> does is to add the checks that the
results are consistent with the criteria outlined above.
<code><a href="https://rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">data.table::merge.data.table</a></code> is generally very fast, and
even if there is a bit of extra calculations in <code>mergeCheck</code>,
it should never be slow.</p>
<p>In summary, <code>mergeCheck</code> verifies that the rows that
result from the merge are the exact same as in one of the existing
datasets, only columns added from the second input dataset. You may
think that this will limit your merges, and that you need merges for
inner and outer joins etc. You are exactly right -
<code>mergeCheck</code> is not intended for those merges and does not
support them. When that is said, the kind of merges that are supported
by <code>mergeCheck</code> are indeed very common. All merges in the
<code>NMdata</code> package are performed with
<code>mergeCheck</code>.</p>
<div class="section level4">
<h4 id="additional-mergecheck-features">Additional <code>mergeCheck</code> features<a class="anchor" aria-label="anchor" href="#additional-mergecheck-features"></a>
</h4>
<p>Another problem the programmer may not realize during a merge is when
column names are shared across <code>x1</code> and <code>x2</code> (in
addition to columns that are being merged by). This will silently create
column names like <code>col.x</code> and <code>col.y</code> in the
output. <code>mergeCheck</code> will by default give a warning if that
happens (can be modified using the <code>fun.commoncols</code>
argument). Also, there is an optional argument to tell mergeCheck how
many columns are expected to be added by the merge, and
<code>mergeCheck</code> will fail if another number of columns are
added. This can be useful for programming.</p>
<p>The row order of the first data set is by default maintained by
<code>mergeCheck</code>. Apart from this, there is only one difference
from the behavior of the <code>merge.data.frame</code> function syntax,
being that either the <code>by</code> argument or <code>by.x</code> and
<code>by.y</code> must always be supplied to <code>mergeCheck</code>.
Default behavior of <code>merge.data.frame</code> is to merge by all
common column names, but for coding transparency, this is intentionally
not allowed by <code>mergeCheck</code>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="time-since-previous-dose-cumulative-number-of-doses-etc-">Time since previous dose, cumulative number of doses etc.<a class="anchor" aria-label="anchor" href="#time-since-previous-dose-cumulative-number-of-doses-etc-"></a>
</h2>
<p>In addition to stacking doses and concentration data and merging in
covariates, we often need to derive time since previous dose, we may
want to cumulatively count the number and amounts of drug administered,
keep track of previous dose amount and most recent dosing time. These
are all within at least the subject subject. <code>addTAPD.R</code> adds
these really easily.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cnames.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span></span>
<span><span class="va">pk.tapd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addTAPD.html">addTAPD</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span></span>
<span><span class="va">cnames.tapd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pk.tapd</span><span class="op">)</span></span>
<span><span class="co">## These are the columns added by addTAPD</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">cnames.tapd</span>, <span class="va">cnames.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DOSCUMN" "TPDOS"   "TAPD"    "PDOSAMT" "DOSCUMA"</span></span></code></pre></div>
<p>By default, the column names shown above are used.
<code>addTAPD</code> takes arguments to customize the generated column
names and of course to indicate what columns are store the used
information, such as dose amounts, time etc. By default,
<code>addTAPD</code> adds the five columns listed above. The following
example derives time since previous dose based on nominal time, uses
customized names for derived column names, and skips derivation of
cumulated dose amount.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk.tapd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addTAPD.html">addTAPD</a></span><span class="op">(</span><span class="va">pk</span>, col.time <span class="op">=</span> <span class="st">"NOMTIME"</span>, col.tapd <span class="op">=</span> <span class="st">"NTAPD"</span>,</span>
<span>    col.tpdos <span class="op">=</span> <span class="st">"NTPDOS"</span>, col.ndoses <span class="op">=</span> <span class="st">"NOMNDOSES"</span>, col.doscuma <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="co">#&gt; col.ndoses is a deprecated argument. Please use col.doscumn instead.</span></span>
<span><span class="va">cnames.tapd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pk.tapd2</span><span class="op">)</span></span>
<span><span class="co">## These are the columns added by addTAPD</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">cnames.tapd2</span>, <span class="va">cnames.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DOSCUMN" "NTPDOS"  "NTAPD"   "PDOSAMT"</span></span></code></pre></div>
<p><code>addTAPD</code> uses information in <code>TIME</code>,
<code>ID</code>, <code>EVID</code> and <code>AMT</code> (names of
columns holding this information can be speified using arguments). It
respects repeated dosing defined in <code>ADDL</code> and
<code>II</code>. Under the hood, <code>NMexpandDoses</code> is used to
achieve this but the returned data will have the exact same rows as the
input data (i.e. if doses are expanded, it is only for internal
calculations on the existing rows).</p>
</div>
<div class="section level2">
<h2 id="exclusion-flags">Exclusion flags<a class="anchor" aria-label="anchor" href="#exclusion-flags"></a>
</h2>
<p>There is no way around excluding some of the events in data due to
various reasons. We need to be able to answer to why we excluded each of
the points, and to how many points were excluded due to which criteria.
<code>NMdata</code> provides two functions to handle this -
<code>flagsAssign</code> assigns exclusion flags to data records (rows),
and <code>flagsCount</code> summarizes the number of discarded rows and
the reasons.</p>
<p>This implementation makes it easy to keep the rows flagged for
exclusion in the dataset and ignore them in NONMEM. Or if you prefer,
you can remove the rows after generating an overview of the exclusion
counts for your report.</p>
<p><code>flagsAssign</code> and <code>flagsCount</code> are based on
sequential evaulation of exclusion criteria. This means we can summarize
how many records and subjects were excluded from the analysis due to the
different criteria. The information is represented in one numerical
column for NONMEM, and one (value-to-value corresponding) character
column for the rest of us in the resulting data.</p>
<div class="section level3">
<h3 id="assign-and-count-flags">Assign and count flags<a class="anchor" aria-label="anchor" href="#assign-and-count-flags"></a>
</h3>
<p>For use in NONMEM’s <code>IGNORE</code> feature, the easiest is that
inclusion/exclusion is determined by a single column in data - we call
that column <code>FLAG</code> here, but any column name can be used.
<code>FLAG</code> obviously draws on information from other columns such
as <code>TIME</code>, <code>DV</code>, and many others, depending on
your dataset and your way of working.</p>
<p>The function that applies exclusion rules is called
<code>flagsAssign</code>, and it takes a dataset and a data.frame with
rules as arguments. In this example we consider four different reasons
to exclude samples - and only samples (keeping all doses in the
analysis). We exclude all pre-dose samples. We also exclude samples with
missing time, missing value, and we exclude those below LLOQ. The
<code>data.frame</code> with these rules looks like this</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt.flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"FLAG,  flag,               condition</span></span>
<span><span class="st">                           40,    Pre-dose sample,    !is.na(TIME) &amp; TIME&lt;0</span></span>
<span><span class="st">                           30,    Missing time,       is.na(TIME)</span></span>
<span><span class="st">                           20,    Missing value,      is.na(DV)</span></span>
<span><span class="st">                           10,    Below LLOQ,         BLQ==1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dt.flags</span></span>
<span><span class="co">#&gt;     FLAG            flag             condition</span></span>
<span><span class="co">#&gt;    &lt;int&gt;          &lt;char&gt;                &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:    40 Pre-dose sample !is.na(TIME) &amp; TIME&lt;0</span></span>
<span><span class="co">#&gt; 2:    30    Missing time           is.na(TIME)</span></span>
<span><span class="co">#&gt; 3:    20   Missing value             is.na(DV)</span></span>
<span><span class="co">#&gt; 4:    10      Below LLOQ                BLQ==1</span></span></code></pre></div>
<p><code>fread</code> is used to create a data.table (like
<code>read.csv</code> to create a data.frame) for readability, one line
for each row in the data.table created. Notice how <code>FLAG</code> is
numeric and interpretable by NONMEM, <code>flag</code> is descriptions
interpretable by humans, and <code>condition</code> is expressions
interpretable by R.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flagsAssign.html">flagsAssign</a></span><span class="op">(</span><span class="va">pk</span>, tab.flags <span class="op">=</span> <span class="va">dt.flags</span>, subset.data <span class="op">=</span> <span class="st">"EVID==0"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coding FLAG = 40, flag = Pre-dose sample</span></span>
<span><span class="co">#&gt; Coding FLAG = 30, flag = Missing time</span></span>
<span><span class="co">#&gt; Coding FLAG = 20, flag = Missing value</span></span>
<span><span class="co">#&gt; Coding FLAG = 10, flag = Below LLOQ</span></span></code></pre></div>
<p><code>flagsAssign</code> applies the conditions sequentially and by
decreasing value of <code>FLAG</code>. <code>FLAG=0</code> means that
the observation is included in the analysis. You can use any expression
that can be evaluated within the data.frame. In this case, numeric
<code>TIME</code>, <code>DV</code>, and <code>BLQ</code> culomns must
exist in <code>pk</code>.</p>
<p>Finally, flags are assigned to <code>EVID==1</code> rows. Here, no
flag table is used. This means that all <code>EVID==1</code> rows will
get <code>FLAG=0</code> and <code>flag="Dose"</code>. You can use a
separate data.frame of flags for dosing records as needed.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flagsAssign.html">flagsAssign</a></span><span class="op">(</span><span class="va">pk</span>, subset.data <span class="op">=</span> <span class="st">"EVID==1"</span>, flagc.0 <span class="op">=</span> <span class="st">"Dose"</span><span class="op">)</span></span></code></pre></div>
<p>Again, the omission will be attributed to the first condition
matched. Default is to apply the conditions by the order of decreasing
numerical flag value. Use <code>flags.increasing=TRUE</code> if you
prefer the opposite. However, what cannot be modified is that 0 is the
numerical value for rows that are not matched by any conditions.</p>
<p>In NONMEM, we can now include <code>IGNORE=(FLAG.NE.0)</code> in
<code>$DATA</code> or <code>$INFILE</code>. NMwriteData (see later in
this vignette) will by default look for <code>FLAG</code> and suggest an
IGNORE statement for <code>$DATA</code>.</p>
<p>What rows to omit from a data set can vary from one analysis to
another. Hence, the aim with the chosen design is that the inclusion
criteria can be changed and applied to overwrite an existing
inclusion/exclusion selection. For another analysis we want to include
the observations below LLOQ. We have two options. Either we simply
change the <code>IGNORE</code> statement given above to
<code>IGNORE=(FLAG.LT.10)</code>, or you create a different exclusion
flag for that one. If you prefer to create a new set of exclusion flags,
just use new names for the numerical and the character flag columns so
you don’t overwrite the old ones. See help of <code>flagsAssign</code>
and <code>flagsCount</code> for how - arguments are called
<code>col.flagn</code> and <code>col.flagc</code>.</p>
</div>
<div class="section level3">
<h3 id="summarize-data-exclusions">Summarize data exclusions<a class="anchor" aria-label="anchor" href="#summarize-data-exclusions"></a>
</h3>
<p>An overview of the number of observations disregarded due to the
different conditions is then obtained using <code>flagsCount</code>. As
we see from the <code>names</code> call below, both discarded,
cumulative discarded, and observations left after application of the
respective criterion are available. Choose the ones you prefer - here we
show how many observations and subjects were matched by each criterion
and how many were left after application of each criterion.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tab.count</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flagsCount.html">flagsCount</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pk</span><span class="op">[</span><span class="va">EVID</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>, tab.flags <span class="op">=</span> <span class="va">dt.flags</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tab.count</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "flag"          "N.left"        "Nobs.left"     "N.discard"    </span></span>
<span><span class="co">#&gt; [5] "N.disc.cum"    "Nobs.discard"  "Nobs.disc.cum"</span></span>
<span><span class="va">tab.count</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>`Data cleaning step` <span class="op">=</span> <span class="va">flag</span>, <span class="va">N.discard</span>, <span class="va">Nobs.discard</span>,</span>
<span>    <span class="va">N.left</span>, <span class="va">Nobs.left</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">kable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">Data cleaning step</th>
<th align="right">N.discard</th>
<th align="right">Nobs.discard</th>
<th align="right">N.left</th>
<th align="right">Nobs.left</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">All available data</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">150</td>
<td align="right">1352</td>
</tr>
<tr class="even">
<td align="left">Pre-dose sample</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">150</td>
<td align="right">1350</td>
</tr>
<tr class="odd">
<td align="left">Missing time</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">150</td>
<td align="right">1350</td>
</tr>
<tr class="even">
<td align="left">Missing value</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">150</td>
<td align="right">1350</td>
</tr>
<tr class="odd">
<td align="left">Below LLOQ</td>
<td align="right">19</td>
<td align="right">595</td>
<td align="right">131</td>
<td align="right">755</td>
</tr>
<tr class="even">
<td align="left">Analysis set</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">131</td>
<td align="right">755</td>
</tr>
</tbody>
</table>
<p>Notice that each row in the summary table does not describe how many
observations <em>matched</em> the criterion, but how many observations
were <em>excluded</em> due to the criterion. For instance, two samples
are excluded due to values below LLOQ. All the predose samples may also
be below LLOQ. By the order of the <code>FLAG</code> values however, we
decided that we wanted to exclude this samples no matter of their
values. Hence they are counted in that and only that bin.</p>
<p><code>flagsCount</code> includes a <code>file</code> argument to save
the the table as a csv right away.</p>
</div>
</div>
<div class="section level2">
<h2 id="finalize-data-format-and-write-to-file">Finalize data format and write to file<a class="anchor" aria-label="anchor" href="#finalize-data-format-and-write-to-file"></a>
</h2>
<p>Once the dataset is in place, <code>NMdata</code> provides a few
useful functions to ensure the formatting of the written data is
compatible with NONMEM. These functions include checks that NONMEM will
be able to interpret the data as intended, and more features are under
development in this area.</p>
<div class="section level3">
<h3 id="automated-ordering-of-columns">Automated ordering of columns<a class="anchor" aria-label="anchor" href="#automated-ordering-of-columns"></a>
</h3>
<p>The order of columns in NONMEM is important for two reasons. One is
that a character in a variable read into NONMEM will make the run fail.
The other is that there are restrictions on the number of variables you
can read into NONMEM, depending on the version.
<code>NMorderColumns</code> tries to put the used columns first, and
other or maybe even unusable columns in the back of the dataset. It does
so by a mix of recognition of column names and analysis of the column
contents.</p>
<p>Columns that cannot be converted to numeric are put in the back,
while column bearing standard NONMEM variable names like
<code>ID</code>, <code>TIME</code>, <code>EVID</code> etc. will be
pulled up front. You can of course add column names to prioritize to
front (<code>first</code>) or back (<code>last</code>). See
<code><a href="../reference/NMorderColumns.html">?NMorderColumns</a></code> for more options.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMorderColumns.html">NMorderColumns</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span></span></code></pre></div>
<p>One trick is worth mentioning here. If you are adding variables to a
data set after having started to model with NONMEM, you may not want to
have to update and rerun your NONMEM models right away.
<code>NMorderColumns</code> has options for putting some variable last
(to the right) in data. That argument is called <code>last</code>. It
has several other options to tweak how the columns are ordered so you
can hopefully get the order you want.</p>
</div>
</div>
<div class="section level2">
<h2 id="checking-the-data-set">Checking the data set<a class="anchor" aria-label="anchor" href="#checking-the-data-set"></a>
</h2>
<p>Before we save the data and go to model estimation,
<code>NMdata</code> offers a quite extensive and automated function to
check data for consistency and compatibility with NONMEM.</p>
<p><code>NMcheckData</code> checks all the standard NONMEM columns
against the NONMEM requirements and looks for other common data issues.
The list is quite long. Please see <code><a href="../reference/NMcheckData.html">?NMcheckData</a></code> for a list
of performed checks.</p>
<p>We can add subject level covariates, and subject-occasion covariates
to be checked for whether they are non-missing, numeric and not varying
with subject or subject-occasion. We can also add other numeric
variables to use in NONMEM to check for missing values.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">findings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcheckData.html">NMcheckData</a></span><span class="op">(</span><span class="va">pk</span>, covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DOSE"</span>, <span class="st">"WEIGHTB"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   column                     check     N   Nid</span></span>
<span><span class="co">#&gt;   &lt;char&gt;                    &lt;char&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt;     EVID        Subject has no obs    19    19</span></span>
<span><span class="co">#&gt;      MDV          Column not found     1     0</span></span>
<span><span class="co">#&gt;  WEIGHTB  Cov not unique within ID     1     1</span></span>
<span><span class="co">#&gt;      AMT Non-positive dose amounts     1     1</span></span>
<span><span class="co">#&gt;     EVID           EVID not in 0:4     1     1</span></span></code></pre></div>
<p>Let’s look at these findings:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">findings</span></span>
<span><span class="co">#&gt;     row  ID  column                     check  level  ROW</span></span>
<span><span class="co">#&gt; 1    NA  31    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 2    NA  32    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 3    NA  33    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 4    NA  34    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 5    NA  36    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 6    NA  37    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 7    NA  38    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 8    NA  39    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 9    NA  42    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 10   NA  44    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 11   NA  45    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 12   NA  46    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 13   NA  49    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 14   NA  52    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 15   NA  53    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 16   NA  56    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 17   NA  57    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 18   NA  58    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 19   NA  60    EVID        Subject has no obs     ID   NA</span></span>
<span><span class="co">#&gt; 20   NA  NA     MDV          Column not found column   NA</span></span>
<span><span class="co">#&gt; 21   NA 180 WEIGHTB  Cov not unique within ID     ID   NA</span></span>
<span><span class="co">#&gt; 22 1403 171     AMT Non-positive dose amounts    row 1403</span></span>
<span><span class="co">#&gt; 23 1480 178    EVID           EVID not in 0:4    row 1480</span></span></code></pre></div>
<p>Depending on <code>level</code> we can now take a look at single
rows, data from a subject or fix a column to address these. The fact
that some subjects are missing observations in this case is not
necessarily an error (they are in this case all BLQ), but
<code>WEIGHTB</code> has to be constant within subjects, and for NONMEM
to even run, <code>EVID</code> must be in <code>0:4</code>. So those
have to be fixed. For the rest of the vignette, assume we fixed those
issues.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">pk.copy</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="writing-data-to-files">Writing data to files<a class="anchor" aria-label="anchor" href="#writing-data-to-files"></a>
</h3>
<p>For the final step of writing the dataset, <code>NMwriteData</code>
is provided. Most importantly, it writes a csv file with appropriate
options for NONMEM to read it as well as possible. It can also write an
rds for R with equal contents (or RData if you prefer), but with the rds
including all information (such as factor levels) which cannot be saved
in csv. If you should use <code>NMscanData</code> to read NONMEM
results, this information can be used automatically.
<code>NMwriteData</code> also by default calls <code>NMgenText</code>
which provides a proposal for text to include in the <code>$INPUT</code>
and <code>$DATA</code> sections of the NONMEM control streams. There are
several arguments that will affect the proposed text for the NONMEM run,
see <code><a href="../reference/NMwriteData.html">?NMwriteData</a></code> and especially
<code><a href="../reference/NMgenText.html">?NMgenText</a></code>.</p>
<p>Let’s include the origin script of the data as meta data.
<code>write.csv=TRUE</code> is default but included here because we
often want to use something like <code>write.csv=writeOutput</code>
where <code>writeOutput</code> is a switching variable we set to
<code>TRUE</code> or <code>FALSE</code> in the initialization section of
the script.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">text.nm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMwriteData.html">NMwriteData</a></span><span class="op">(</span><span class="va">pk</span>, file <span class="op">=</span> <span class="st">"derived/pkdata.csv"</span>, script <span class="op">=</span> <span class="st">"DataPrepare.Rmd"</span>,</span>
<span>    write.csv <span class="op">=</span> <span class="cn">TRUE</span>, args.stamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Description <span class="op">=</span> <span class="st">"PK data for the Data Preparation vignette."</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; arguments in the format write.xxx are deprecated. Use the `formats.write` argument instead. Example: formats.write=c("csv","rds")</span></span>
<span><span class="co">#&gt; For NONMEM:</span></span>
<span><span class="co">#&gt; $INPUT ROW ID NOMTIME TIME EVID CMT AMT DV FLAG STUDY BLQ CYCLE DOSE</span></span>
<span><span class="co">#&gt; PART PROFDAY PROFTIME WEIGHTB eff0</span></span>
<span><span class="co">#&gt; $DATA derived/pkdata.csv</span></span>
<span><span class="co">#&gt; IGN=@</span></span>
<span><span class="co">#&gt; IGNORE=(FLAG.NE.0)</span></span>
<span><span class="co">#&gt; Data written to file(s):</span></span>
<span><span class="co">#&gt; derived/pkdata.csv</span></span>
<span><span class="co">#&gt; derived/pkdata.rds</span></span></code></pre></div>
<p>We are being told that two files were saved, and then we get some
text to use in the NONMEM control streams. <code>NMwriteData</code>
detected the exclusion flag and suggests to include it in
<code>$DATA</code>.</p>
<p>Let’s take a look at what was saved:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"derived"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "pkdata_meta.txt" "pkdata.csv"      "pkdata.rds"</span></span></code></pre></div>
<p>There is a metadata file which <code>NMreadCsv</code> will
automatically recognize if found. The metadata becomes accessible using
<code>NMinfo</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.inp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadCsv.html">NMreadCsv</a></span><span class="op">(</span><span class="st">"derived/pkdata.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/NMinfo.html">NMinfo</a></span><span class="op">(</span><span class="va">dat.inp</span><span class="op">)</span></span>
<span><span class="co">#&gt; $dataCreate</span></span>
<span><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span><span class="co">#&gt; [1] "DataPrepare.Rmd"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span><span class="co">#&gt; [1] "2024-03-18 21:23:17.354702"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$writtenTo</span></span>
<span><span class="co">#&gt; [1] "derived/pkdata.rds derived/pkdata.csv"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$Description</span></span>
<span><span class="co">#&gt; [1] "PK data for the Data Preparation vignette."</span></span></code></pre></div>
<p>With the flexibility of the <code>rds</code> format, we don’t need
such an additional file. Only difference on the metadata for the rds
file is the filename:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.inp.rds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"derived/pkdata.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/NMinfo.html">NMinfo</a></span><span class="op">(</span><span class="va">dat.inp.rds</span><span class="op">)</span></span>
<span><span class="co">#&gt; $dataCreate</span></span>
<span><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span><span class="co">#&gt; [1] "DataPrepare.Rmd"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span><span class="co">#&gt; [1] "2024-03-18 21:23:17 UTC"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$writtenTo</span></span>
<span><span class="co">#&gt; [1] "derived/pkdata.rds" "derived/pkdata.csv"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$Description</span></span>
<span><span class="co">#&gt; [1] "PK data for the Data Preparation vignette."</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="updating-nonmem-control-streams-to-read-new-data-file">Updating NONMEM control streams to read new data file<a class="anchor" aria-label="anchor" href="#updating-nonmem-control-streams-to-read-new-data-file"></a>
</h3>
<p>If we have to update the input data file, the NONMEM
<code>$INPUT</code> sections no longer match the input data. We saw in
<code>NMorderColumns</code> how we can use the <code>last</code>
argument to get columns pushed towards the back so the NONMEM runs
should still work. But maybe you need the column in your nonmem runs,
and so you have no way around updating the control streams. And that can
be quite a lot of control streams. With <code>NMdata</code> that is
really easy.</p>
<p><code>NMdata</code> has a couple of functions to extract and write
sections to NONMEM control streams called <code>NMreadSection</code> and
<code>NMwriteSection</code>. Those functions are very flexible for
updating NONMEM control streams, and we will not go into detail with
them, but let’s stick to the example above. We can do</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/NMwriteSection.html">NMwriteSection</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="st">"nonmem"</span>, file.pattern <span class="op">=</span> <span class="st">"run1.*\\.mod"</span>,</span>
<span>    list.sections <span class="op">=</span> <span class="va">text.nm</span><span class="op">[</span><span class="st">"INPUT"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>This updates the INPUT section (and not DATA) for all control streams
in directory “nonmem” which file names start with “run1” and end in
“.mod” (say “run101.mod” to “run199.mod”). If we had done simply
<code>list.sections=text.nm</code> instead of
<code>list.sections=text.nm["INPUT"]</code>, it would have replaced the
<code>$DATA</code> section too. However, the <code>DATA</code> section
rarely needs update following an update of the input data file, and
oftentimes <code>$DATA</code> can vary among control streams that use
the same input data (some models may be estimated on a smaller subset of
data), so be careful with that.</p>
<p><code>NMwriteSection</code> has the argument <code>data.file</code>
to further limit the scope of files to update based on what data file
the control streams use. It only makes sense to use the auto-generated
text for control streams that use this data set.</p>
<p>The text for NONMEM can be generated without saving data using
<code>NMgenText</code>. You can tailor the generation of the text to
copy <code>(DV=CONC)</code>, drop <code>(COL=DROP)</code>, rename
(<code>DV</code> instead of <code>CONC</code>) and more.</p>
</div>
</div>
<div class="section level2">
<h2 id="stamp-objects-for-traceability">Stamp objects for traceability<a class="anchor" aria-label="anchor" href="#stamp-objects-for-traceability"></a>
</h2>
<p>We saw how <code>NMwriteDatat</code> saves metadata automatically.
Even if <code>NMwriteData</code> can actually be used as a simple rds
writer that adds meta data the same way, we may want to save data or any
R object using <code>saveRDS</code>. In that case, use
<code>NMstamp</code> (which is also what <code>NMwriteData</code>
does).</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMstamp.html">NMstamp</a></span><span class="op">(</span><span class="va">pk</span>, script <span class="op">=</span> <span class="st">"vignettes/DataCreate.Rmd"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/NMinfo.html">NMinfo</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span></span>
<span><span class="co">#&gt; $dataCreate</span></span>
<span><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span><span class="co">#&gt; [1] "vignettes/DataCreate.Rmd"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span><span class="co">#&gt; [1] "2024-03-18 21:23:17 UTC"</span></span></code></pre></div>
<p>The <code>script</code> argument is recognized by
<code>NMstamp</code>, but you can add anything to this. We want to keep
descriptive note too. Another often useful piece of information is what
source data files were read in order to generate the saved data.
<code>Description</code> and <code>Source.Files</code> are only examples
- any name can be used.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMstamp.html">NMstamp</a></span><span class="op">(</span><span class="va">pk</span>, script <span class="op">=</span> <span class="st">"vignettes/DataCreate.Rmd"</span>, Description <span class="op">=</span> <span class="st">"A PK dataset used for examples."</span>,</span>
<span>    Source.Files <span class="op">=</span> <span class="st">"/path/to/adpc.sas7bdat,/path/to/adsl.sas7bdat"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/NMinfo.html">NMinfo</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span></span>
<span><span class="co">#&gt; $dataCreate</span></span>
<span><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span><span class="co">#&gt; [1] "vignettes/DataCreate.Rmd"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span><span class="co">#&gt; [1] "2024-03-18 21:23:17 UTC"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$Description</span></span>
<span><span class="co">#&gt; [1] "A PK dataset used for examples."</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dataCreate$Source.Files</span></span>
<span><span class="co">#&gt; [1] "/path/to/adpc.sas7bdat,/path/to/adsl.sas7bdat"</span></span></code></pre></div>
<p>These are very simple functions. But hopefully they will help you
avoid sitting with a data set trying to guess which script generated
it.</p>
<p>Again, when using <code>NMwriteData</code>, you don’t have to call
<code>NMstamp</code> explicitly. Just pass the <code>script</code>
argument to <code>NMwriteData</code> and <code>NMstamp</code> will be
applied automatically.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  <script data-goatcounter="https://nmdata.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
