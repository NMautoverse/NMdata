<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data creation tools • NMdata</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Data creation tools">
<meta property="og:description" content="NMdata">
<meta property="og:image" content="https://philipdelff.github.io/NMdata/reference/figures/NMdata_logo_v01.png">
<meta property="og:image:alt" content="Efficient data preparation, consistency-checking and post-processing in PK/PD modeling">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NMdata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.7.9.901</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/NMscanData.html">NMscanData: find and combine all output and input data</a>
    </li>
    <li>
      <a href="../articles/DataCreate.html">Data creation tools</a>
    </li>
    <li>
      <a href="../articles/NMdata-FAQ.html">FAQ</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Manual</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://github.com/philipdelff/NMdata">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="DataCreate_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Data creation tools</h1>
            
      
      
      <div class="hidden name"><code>DataCreate.Rmd</code></div>

    </div>

    
    
<p>Built 2021-06-25 using NMdata 0.0.7.9.901.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Getting data ready for modeling is a crucial and tedious but often underestimated task. Mistakes during the process of combining data sets, defining time variables etc. can lead to difficulties during modeling, need for revisiting data set creation, and in the worst case where the errors are not quickly realized, a lot of wasted time working with an erroneos data set. Avoiding those mistakes by integrating checks into the data creation process is a must.</p>
<p>Furthermore, Nonmem has quite a number of restrictions on the format of the input data, and problems with the data set is a very common reason for Nonmem not to behave as expected. When this happens, debugging can be time-consuming. <code>NMdata</code> includes some simple functions to prevent these situations.</p>
<p>This vignette uses <code>data.table</code> syntax for the little bit of data manipulation performed. However, you don’t need to use data.table <em>at all</em> to use these tools or any tool in <code>NMdata</code>. The reason why the functions return data.table objects is that the data set is a <code>data.table</code> to begin with</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span>file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"examples/data/xgxr2.rds"</span>,package<span class="op">=</span><span class="st">"NMdata"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span>
<span class="co">#&gt; [1] "data.table" "data.frame"</span></code></pre></div>
<p>If this was a <code>data.frame</code> (and not a <code>data.table</code>), the <code>NMdata</code> functions would keep returning objects of class <code>data.frame</code>.</p>
</div>
<div id="data-assembly" class="section level2">
<h2 class="hasAnchor">
<a href="#data-assembly" class="anchor"></a>Data assembly</h2>
<div id="compare-presence-and-class-of-columns-across-data-sets" class="section level3">
<h3 class="hasAnchor">
<a href="#compare-presence-and-class-of-columns-across-data-sets" class="anchor"></a>Compare presence and class of columns across data sets</h3>
<p>When stacking (rbind) and merging, it is most often necessary to check if two or more data sets are compatible for the operation. <code>compareCols</code> by defaults lists the columns where the two data sets differ.</p>
<p>Just to illustrate the output of <code>compareCols</code>, a slightly modified version of the <code>pk</code> dataset has been created. On column (<code>CYCLE</code>) has been removed, and <code>AMT</code> has been recoded to character. <code>compareCols</code> tells us about exactly these two differences. So before mergeing or stacking, we may want to recode <code>AMT</code> in one of the datasets to get the class we need, and decide what to do about the missing <code>CYCLE</code> in one of the datasets (if OK, we fill in <code>NA</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/compareCols.html">compareCols</a></span><span class="op">(</span><span class="va">pk</span>,<span class="va">pk.reduced</span><span class="op">)</span></code></pre></div>
</div>
<div id="rename-columns-based-on-contents" class="section level3">
<h3 class="hasAnchor">
<a href="#rename-columns-based-on-contents" class="anchor"></a>Rename columns based on contents</h3>
<p>The model estimation step is heavily dependent (and in Nonmem almost entirely based) on numeric data values. The source data will often contain character variables, i.e. columns with non-numeric data values.</p>
<p>If the column names reflect whether the values are numeric, double-checking can be avoided. <code>renameByContents</code> renames columns if a function of their contents returns <code>TRUE</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pk.renamed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/renameByContents.html">renameByContents</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">pktmp</span>,fun.test<span class="op">=</span><span class="va">NMisNumeric</span>,fun.rename <span class="op">=</span> <span class="va">tolower</span>, invert.test <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><code>NMisNumeric</code> is a function that tests if the contents are numeric to <code>Nonmem</code>. If say the subject ID is of character class, it can be valid to <code>Nonmem</code>. Subject ID <code>"1039"</code> will be a numeric in Nonmem, <code>"1-039"</code> will not. We invert that, and those that Nonmem cannot interpret as numeric become lowercase. We use <code>compareCols</code> to illustrate that three columns were renamed:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/compareCols.html">compareCols</a></span><span class="op">(</span><span class="va">pktmp</span>,<span class="va">pk.renamed</span><span class="op">)</span></code></pre></div>
</div>
<div id="automated-checks-of-merge-results" class="section level3">
<h3 class="hasAnchor">
<a href="#automated-checks-of-merge-results" class="anchor"></a>Automated checks of merge results</h3>
<p>Merges are a very common source of data creation bugs. As simple as they may seem, merges likely leave you with an unexpected number of rows, some repeated or some omitted. <code>mergeCheck</code> provides a merge which is restricted to the specific kind where the rows that come out of the merge are the exact same as in one of the existing datasets, only columns added from the second dataset. This limitation of the scope of the merge allows for a high degree of automated checks of consistency of the results.</p>
<p>Say we want to add a covariate from a <code>dt.cov</code>. Imagine we just assume that all subjects are represented with one row each in <code>dt.cov</code>, and so we expect the number of rows to be unchanged from <code>pk</code>. But we see that only when remembering <code>all.x=T</code>, we get the dimensions we had expected (we do not checked that we get the <em>right</em> rows, only that we get the <em>right number</em> of rows):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span>
<span class="co">#&gt; [1] 1502   24</span>
<span class="co">## the number of unique values of ID in pk</span>
<span class="va">pk</span><span class="op">[</span>,<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; [1] 150</span>
<span class="va">pk</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; [1]  31 180</span>
<span class="co">## dt.cov has a covariate for some of the subjects</span>
<span class="va">dt.cov</span>
<span class="co">#&gt;     ID COV</span>
<span class="co">#&gt;  1: 31   4</span>
<span class="co">#&gt;  2: 32   3</span>
<span class="co">#&gt;  3: 33   1</span>
<span class="co">#&gt;  4: 34   2</span>
<span class="co">#&gt;  5: 35   4</span>
<span class="co">#&gt;  6: 36   5</span>
<span class="co">#&gt;  7: 37   1</span>
<span class="co">#&gt;  8: 38   3</span>
<span class="co">#&gt;  9: 39   1</span>
<span class="co">#&gt; 10: 40   4</span>
<span class="va">pk2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span><span class="op">(</span><span class="va">pk</span>,<span class="va">dt.cov</span>,by<span class="op">=</span><span class="st">"ID"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pk2</span><span class="op">)</span>
<span class="co">#&gt; [1] 100  25</span>
<span class="co">## now as expected</span>
<span class="va">pk3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span><span class="op">(</span><span class="va">pk</span>,<span class="va">dt.cov</span>,by<span class="op">=</span><span class="st">"ID"</span>,all.x<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pk3</span><span class="op">)</span>
<span class="co">#&gt; [1] 1502   25</span></code></pre></div>
<p>So when creating <code>pk2</code> we lost a lot of rows because we forgot the <code>all.x</code> option. And also as we shall now see that checking the resulting dimensions is not enough. In the following example, <code>pk4</code> has the same number of rows as <code>pk</code>, but one row is repeated, another must have disappeared.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pk4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span><span class="op">(</span><span class="va">pk</span>,<span class="va">dt.cov2</span>,by<span class="op">=</span><span class="st">"ID"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pk4</span><span class="op">)</span>
<span class="co">#&gt; [1] 1502   25</span>
<span class="co">## we now have twice as many rows for this subject</span>
<span class="va">pk</span><span class="op">[</span><span class="va">ID</span><span class="op">==</span><span class="fl">31</span>,<span class="va">.N</span><span class="op">]</span>
<span class="co">#&gt; [1] 10</span>
<span class="va">pk4</span><span class="op">[</span><span class="va">ID</span><span class="op">==</span><span class="fl">31</span>,<span class="va">.N</span><span class="op">]</span>
<span class="co">#&gt; [1] 20</span></code></pre></div>
<p>As illustrated by these simple examples, even the simplest merges have to be rigorously checked, no exceptions. The function call <code><a href="../reference/mergeCheck.html">mergeCheck(x1,x2)</a></code> ensures that the result has exactly one of each rows from <code>x1</code> and nothing else. We can use <code>...</code> to pass additional arguments to merge. Here, we need <code>all.x</code> to include rows from <code>x1</code> where <code>ID</code> is not matched by a row in <code>dt.cov</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pk2</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/mergeCheck.html">mergeCheck</a></span><span class="op">(</span><span class="va">pk</span>,<span class="va">dt.cov</span>,by<span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Rows disappeared during merge.</span>
<span class="co">#&gt; Overview of dimensions of input and output data:</span>
<span class="co">#&gt;         data nrows ncols</span>
<span class="co">#&gt; 1:        pk  1502    25</span>
<span class="co">#&gt; 2:    dt.cov    10     2</span>
<span class="co">#&gt; 3: merged.df   100    26</span>
<span class="co">#&gt; Overview of values of by where number of rows in df1 changes:</span>
<span class="co">#&gt;       ID N.df1 N.result</span>
<span class="co">#&gt;   1:  41    10        0</span>
<span class="co">#&gt;   2:  42    10        0</span>
<span class="co">#&gt;   3:  43    10        0</span>
<span class="co">#&gt;   4:  44    10        0</span>
<span class="co">#&gt;   5:  45    10        0</span>
<span class="co">#&gt;  ---                   </span>
<span class="co">#&gt; 136: 176    10        0</span>
<span class="co">#&gt; 137: 177    10        0</span>
<span class="co">#&gt; 138: 178    10        0</span>
<span class="co">#&gt; 139: 179    10        0</span>
<span class="co">#&gt; 140: 180    10        0</span>
<span class="co">#&gt; Error in mergeCheck(pk, dt.cov, by = "ID") : </span>
<span class="co">#&gt;   Merge added and/or removed rows.</span>
<span class="co">## now as expected</span>
<span class="va">pk3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mergeCheck.html">mergeCheck</a></span><span class="op">(</span><span class="va">pk</span>,<span class="va">dt.cov</span>,by<span class="op">=</span><span class="st">"ID"</span>,all.x<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pk3</span><span class="op">)</span>
<span class="co">#&gt; [1] 1502   25</span></code></pre></div>
<p>The result always has the same row order as the <code>x1</code> argument.</p>
<p>Another problem that the programmer may not realize during a merge is that column names are shared across <code>x1</code> and <code>x2</code> (in addition to columns that are being merged by). This will silently create colmn names like <code>col.x</code> and <code>col.y</code> in the output. <code>mergeCheck</code> will by default give a warning if that happens. There is an optional argument to tell mergeCheck how many columns should be added by the merge, and <code>mergeCheck</code> will fail if another number of columns are added. This can be useful for programming.</p>
<p>There is only one difference from the behaviour of the <code>merge.data.frame</code> function syntax, being that the <code>by</code> argument must always be supplied to <code>mergeCheck</code>.</p>
<p>You may think that this will limit your merges, and that you need merges for inner and outer joins etc. You are exactly right - <code>mergeCheck</code> is not intended for those merges and does not support them. When that is said, the kind of merges that are supported by <code>mergeCheck</code> are indeed very common. To illustrate how common, all merges in the <code>NMdata</code> package are performed with <code>mergeCheck</code>.</p>
</div>
</div>
<div id="exclusion-flags" class="section level2">
<h2 class="hasAnchor">
<a href="#exclusion-flags" class="anchor"></a>Exclusion flags</h2>
<p>It is good practice not to discard records from a dataset but to flag them and omit them in model estimation. When reporting the analysis, we also need to account for how many data records were discarded due to which criteria. A couple of functons in <code>NMdata</code> help you do this in a way that is easy to integrate with Nonmem.</p>
<p>The implementation in <code>NMdata</code> is based on sequentially checking exclusion conditions. This means we can summarize how many records and subjects were excluded from the analysis due to the different criteria. The information is represented in one numerical column for Nonmem, and one (value-to-value corresponding) character column for the rest of us in the resulting data.</p>
<div id="assign-and-count-flags" class="section level3">
<h3 class="hasAnchor">
<a href="#assign-and-count-flags" class="anchor"></a>Assign and count flags</h3>
<p>For use in Nonmem, the easiest is that inclusion/exclusion is determined by a single column in data - we call that column <code>FLAG</code> here, but any column name can be used. <code>FLAG</code> obviously draws on information from other columns such as <code>TIME</code>, <code>DV</code>, and many others, depending on your dataset and your way of working.</p>
<p>The function that applies inclusion/excluasion rules is called <code>flagsAssign</code>, and it takes a dataset and a data.frame with rules as arguments.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt.flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span>text<span class="op">=</span><span class="st">"FLAG,flag,condition
10,Below LLOQ,EVID==0&amp;BLQ==1
100,Negative time,EVID==0&amp;TIME&lt;0"</span><span class="op">)</span>

<span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flagsAssign.html">flagsAssign</a></span><span class="op">(</span><span class="va">pk</span>,tab.flags<span class="op">=</span><span class="va">dt.flags</span>,subset.data<span class="op">=</span><span class="st">"EVID==0"</span><span class="op">)</span>
<span class="co">#&gt; Coding FLAG = 100, flag = Negative time</span>
<span class="co">#&gt; Coding FLAG = 10, flag = Below LLOQ</span>
<span class="va">pk</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span>,<span class="va">FLAG</span><span class="op">:=</span><span class="fl">0</span><span class="op">]</span>
<span class="va">pk</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span>,<span class="va">flag</span><span class="op">:=</span><span class="st">"Dosing"</span><span class="op">]</span></code></pre></div>
<p>Your first question may be why <code>fread</code> is used to create a data.table (like <code>read.csv</code> to create a data.frame). The reason is that this way, we can write the information line by line. If you have ten lines in the dataset above and do <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame(FLAG=...,flag=...,condition=...)</a></code> it gets impossible to read what elements of the three columns that correspond.</p>
<p><code>flagsAssign</code> applies the conditions sequentially and by increasing value of <code>FLAG</code>. <code>FLAG=0</code> means that the observation is included in the analysis. You can use any expression that can be evaluated within the data.frame. In this case, <code>BLQ</code> has to exist in <code>pk</code>.</p>
<p>In <code>Nonmem</code>, you can include <code>IGNORE=(FLAG.NE.0)</code> in <code>$DATA</code> or <code>$INFILE</code>.</p>
<p>Again, the omission will be attributed to the first condition matched. Default is to apply the conditions by the order of decreasing numerical flag value. There is an argument if you prefer the opposite. However, what cannot be modified is that 0 is the numerical value for rows that are not matched by any conditions.</p>
<p>What rows to omit from a dataset can vary from one analysis to another. Hence, the aim with the chosen design is that the inclusion criteria can be changed and applied to overwrite an existing inclusion/exclusion selection. For another analysis we want to include the observations below LLOQ. We have two options. Either we simply change the <code>IGNORE</code> statement given above to <code>IGNORE=(FLAG.LT.10)</code>, or you create a different exclusion flag for that one. If you prefer to create a new set of exclusion flags, just use new names for the numerical and the character flag columns so you don’t overwrite the old ones. See help of <code>flagsAssign</code> and <code>flagsCount</code> for how.</p>
</div>
<div id="summarize-data-exclusions" class="section level3">
<h3 class="hasAnchor">
<a href="#summarize-data-exclusions" class="anchor"></a>Summarize data exclusions</h3>
<p>An overview of the number of observations disregarded due to the different conditions is then obtained using <code>flagsCount</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tab.count</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flagsCount.html">flagsCount</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">pk</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>,tab.flags<span class="op">=</span><span class="va">dt.flags</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tab.count</span><span class="op">)</span>
<span class="co">#&gt;                  flag N.left Nobs.left N.discard N.disc.cum Nobs.discard</span>
<span class="co">#&gt; 1: All available data    150      1352        NA          0           NA</span>
<span class="co">#&gt; 2:      Negative time    150      1350         0          0            2</span>
<span class="co">#&gt; 3:         Below LLOQ    131       755        19         19          595</span>
<span class="co">#&gt; 4:       Analysis set    131       755        NA         19           NA</span>
<span class="co">#&gt;    Nobs.disc.cum</span>
<span class="co">#&gt; 1:             0</span>
<span class="co">#&gt; 2:             2</span>
<span class="co">#&gt; 3:           597</span>
<span class="co">#&gt; 4:           597</span></code></pre></div>
<p><code>flagsCount</code> includes a <code>file</code> argument to save the the table right away.</p>
</div>
</div>
<div id="finalize-data-format-and-write-to-file" class="section level2">
<h2 class="hasAnchor">
<a href="#finalize-data-format-and-write-to-file" class="anchor"></a>Finalize data format and write to file</h2>
<p>Once you have your dataset in place, <code>NMdata</code> provides a few useful functions. At this point, ideally you check your data for any inconsistency. If you miss an inconsistency, you need to wait for Nonmem to finish if the inconsistency is not fatal for Nonmem’s ability to run the model. Then, you may or may not realize the inconcisteny quickly. <code>NMdata</code> is still ways from providing a sufficient set of tests to run, but already includes some checks that are useful and easy to run.</p>
<div id="automated-ordering-of-columns" class="section level3">
<h3 class="hasAnchor">
<a href="#automated-ordering-of-columns" class="anchor"></a>Automated ordering of columns</h3>
<p>The order of columns in Nonmem is important for two reasons. One is that a character in a variable read into Nonmem will make the run fail. The other is that there are restrictions on the number of variables you can read into Nonmem, depending on the version. <code>NMorderColumns</code> tries to put the used columns first, and other or maybe even unusable columns in the back of the dataset. It does so by a mix of recognition of column names and analysis of the column contents.</p>
<p>Columns that cannot be converted to numeric are put in the back, while column bearing standard Nonmem variable names like <code>ID</code>, <code>TIME</code>, <code>EVID</code> etc. will be pulled up front. You can of course add column names to prioritize to front (<code>first</code>) or back (<code>last</code>). See <code><a href="../reference/NMorderColumns.html">?NMorderColumns</a></code> for more options.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMorderColumns.html">NMorderColumns</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span>
<span class="co">#&gt; These standard nonmem columns were not found in data: MDV</span></code></pre></div>
<p>We may want to add <code>MDV</code> and rerun <code>NMorderColumns</code>.</p>
</div>
<div id="writing-data-to-files" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-data-to-files" class="anchor"></a>Writing data to files</h3>
<p>For the final step of writing the dataset, <code>NMwriteData</code> is provided. Most importantly, it writes a csv file with appropriate options for Nonmem to read it as well as possible. It can also write an rds for R with equal contents (or RData if you prefer), but with the rds including all information (such as factor levels) which cannot be saved in csv. If you should use <code>NMscanData</code> to read Nonmem results, this information can be used automatically. It also provides a proposal for text to include in the <code>$INPUT</code> and <code>$DATA</code> sections of the Nonmem control streams.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/NMwriteData.html">NMwriteData</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span>
<span class="co">#&gt; Data _not_ witten to any files.</span>
<span class="co">#&gt; For NonMem:</span>
<span class="co">#&gt; $INPUT ROW ID NOMTIME TIME EVID CMT AMT DV FLAG STUDY BLQ CYCLE DOSE</span>
<span class="co">#&gt; PART PROFDAY PROFTIME WEIGHTB eff0</span>
<span class="co">#&gt; $DATA </span>
<span class="co">#&gt; IGN=@</span>
<span class="co">#&gt; IGNORE=(FLAG.NE.0)</span></code></pre></div>
<p>Notice, <code>NMwriteData</code> detected the exclusion flag and suggests to include it in <code>$DATA</code>.</p>
<p>If a file name had been provided, the data would have been written, and the path to the data file would have been included in the message written back to the user. There are several arguments that will affect the proposed text for the Nonmem run, see <code><a href="../reference/NMwriteData.html">?NMwriteData</a></code>.</p>
</div>
<div id="updating-nonmem-control-streams-to-read-new-data-file" class="section level3">
<h3 class="hasAnchor">
<a href="#updating-nonmem-control-streams-to-read-new-data-file" class="anchor"></a>Updating Nonmem control streams to read new data file</h3>
<p>I may be the only one, but sometimes during the modeling stage, I want to go back and change or add something to the data creation step. Then once I have written a new data file, my Nonmem <code>$INPUT</code> sections no longer match the data file. In <code>NMwriteData</code> you can use a <code>last</code> argument to get columns pushed towards the back so the Nonmem runs should still work, but maybe you need the column in your nonmem runs, and so you have no way around updating the control streams. And that can be quite a lot of control streams.</p>
<p><code>NMdata</code> has a couple of functions to extract and write sections to Nonmem control streams called <code>NMreadSection</code> and <code>NMwriteSection</code>. We are not going into detail with what these functions can do, but let’s stick to the example above. We can do</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/NMwriteSection.html">NMwriteSection</a></span><span class="op">(</span><span class="st">"run001.mod"</span>,<span class="st">"INPUT"</span>,<span class="st">"$INPUT ROW ID TIME EVID CMT AMT DV FLAG STUDY BLQ CYCLE DOSE FLAG2 NOMTIME PART PROFDAY PROFTIME WEIGHTB eff0"</span><span class="op">)</span></code></pre></div>
<p>But in fact, we can go a step further and take the information straight from NMwriteData</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text.nm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMwriteData.html">NMwriteData</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span>
<span class="co">#&gt; Data _not_ witten to any files.</span>
<span class="co">#&gt; For NonMem:</span>
<span class="co">#&gt; $INPUT ROW ID NOMTIME TIME EVID CMT AMT DV FLAG STUDY BLQ CYCLE DOSE</span>
<span class="co">#&gt; PART PROFDAY PROFTIME WEIGHTB eff0</span>
<span class="co">#&gt; $DATA </span>
<span class="co">#&gt; IGN=@</span>
<span class="co">#&gt; IGNORE=(FLAG.NE.0)</span></code></pre></div>
<p>NMwriteData invisibly returns a list of sections (<code>$INPUT</code> and <code>$DATA</code>). <code>NMwriteSection</code> can use these directly. So to write only the <code>$INPUT</code> section to <code>run001.mod</code>, we do the following. Please notice the single brackets in <code>text.nm["INPUT"]</code> which mean that we still send a list to <code>NMwriteSection</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/NMwriteSection.html">NMwriteSection</a></span><span class="op">(</span><span class="st">"run001.mod"</span>,list.sections<span class="op">=</span><span class="va">text.nm</span><span class="op">[</span><span class="st">"INPUT"</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>If you run this in a loop over the control streams that use the created data set, you are all set to rerun the models as needed.</p>
</div>
</div>
<div id="stamp-objects-for-traceability" class="section level2">
<h2 class="hasAnchor">
<a href="#stamp-objects-for-traceability" class="anchor"></a>Stamp objects for traceability</h2>
<p>The last couple of functions that will be introduced here are used for tracing datasets to data creation scripts, including time stamps and other information you want to include with the data set.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stampObj.html">stampObj</a></span><span class="op">(</span><span class="va">pk</span>,script<span class="op">=</span><span class="st">"vignettes/DataCreate.Rmd"</span><span class="op">)</span>
<span class="co">#&gt; Warning: 'stampObj' is deprecated.</span>
<span class="co">#&gt; Use 'NMstamp' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="fu"><a href="../reference/objInfo.html">objInfo</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span>
<span class="co">#&gt; Warning: 'objInfo' is deprecated.</span>
<span class="co">#&gt; Use 'NMinfo' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="co">#&gt; $DataCreateScript</span>
<span class="co">#&gt; [1] "vignettes/DataCreate.Rmd"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $CreationTime</span>
<span class="co">#&gt; [1] "2021-06-25 03:03:18 UTC"</span></code></pre></div>
<p>The <code>script</code> argument is recognized by <code>stampObj</code>, but you can add anything to this. Say you want to keep descriptive note too:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stampObj.html">stampObj</a></span><span class="op">(</span><span class="va">pk</span>,script<span class="op">=</span><span class="st">"vignettes/DataCreate.Rmd"</span>,Description<span class="op">=</span><span class="st">"A PK dataset used for examples."</span><span class="op">)</span>
<span class="co">#&gt; Warning: 'stampObj' is deprecated.</span>
<span class="co">#&gt; Use 'NMstamp' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="fu"><a href="../reference/objInfo.html">objInfo</a></span><span class="op">(</span><span class="va">pk</span><span class="op">)</span>
<span class="co">#&gt; Warning: 'objInfo' is deprecated.</span>
<span class="co">#&gt; Use 'NMinfo' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="co">#&gt; $DataCreateScript</span>
<span class="co">#&gt; [1] "vignettes/DataCreate.Rmd"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $CreationTime</span>
<span class="co">#&gt; [1] "2021-06-25 03:03:18 UTC"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $Description</span>
<span class="co">#&gt; [1] "A PK dataset used for examples."</span></code></pre></div>
<p>These are very simple functions. But they are simple to use as well, and hopefully they will help you avoid sitting with a data set trying to guess which script generated it so you can do a modification or understand how something was done.</p>
<p>When using <code>NMwriteData</code>, you don’t have to call <code>stampObj</code> explicitly. Just pass the <code>script</code> argument to <code>NMwriteData</code> and <code>stampObj</code> will be applied automatically.</p>
</div>
<div id="subject-level-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#subject-level-variables" class="anchor"></a>Subject-level variables</h2>
<p>In a proper PK/PD analysis we need to explore the data at multiple variability levels. What we looked at above is at dosing and sampling level (one row per dosing or sampling event). <code>NMdata</code> provides very useful functions to extract information at other levels of variability. Before extracting the subject-level information we will add an individual exposure measure to the dataset. We will use the empirical Bayes’ estimate of the individual maximum concentration. This is derived as the maximum prediction across the sample times - it may be better to simulate the model at a richer time scale to get better precision. Again, we make use of <code>data.table</code> but feel free to use what you prefer. <code>findCovs</code> - like other <code>NMdata</code> functions - will work on <code>data.frame</code>’s, <code>tibble</code>’s and other <code>data.frame</code>-like classes (classes that inherit from <code>data.frame</code>).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMscanData.html">NMscanData</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr001.lst"</span>, package<span class="op">=</span><span class="st">"NMdata"</span><span class="op">)</span>,
                   col.row<span class="op">=</span><span class="st">"ROW"</span>,merge.by.row<span class="op">=</span><span class="cn">TRUE</span>,quiet<span class="op">=</span><span class="cn">TRUE</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span>
<span class="va">res1</span><span class="op">$</span><span class="va">trtact</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">trtact</span>,<span class="va">res1</span><span class="op">$</span><span class="va">DOSE</span><span class="op">)</span>
<span class="co">## with data.table, create a new column representing ID-level Cmax</span>
<span class="va">res1</span><span class="op">[</span>,<span class="va">Cmax</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">IPRED</span><span class="op">)</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">]</span>
<span class="co">## findCovs picks the columns that do not vary within cols.id. One row</span>
<span class="co">## per value of cols.id.</span>
<span class="va">res1.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findCovs.html">findCovs</a></span><span class="op">(</span><span class="va">res1</span>,cols.id<span class="op">=</span><span class="st">"ID"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">res1.id</span><span class="op">)</span>
<span class="co">#&gt; [1] 150  26</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">res1.id</span>,<span class="fu">aes</span><span class="op">(</span><span class="va">WEIGHTB</span>,<span class="va">Cmax</span><span class="op">/</span><span class="va">DOSE</span>,colour<span class="op">=</span><span class="va">trtact</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Bodyweight at baseline (kg)"</span><span class="op">)</span></code></pre></div>
<p><img src="DataCreate_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
<p><code>cols.id</code> can be longer than one. Include a study column, a treatment column to support cross-over, or a model column if you are comparing model fits (see below how to do this very easily).</p>
<p>If your model includes occasion variability, you probably also want to look at</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## we have no occasion variability in this data</span>
<span class="co">## res1.id.occ &lt;- findCovs(res1,cols.id=c("ID","OCC"))</span></code></pre></div>
<p>The simplest use of <code>findCovs</code> is to get variables that are constant across the whole dataset:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/findCovs.html">findCovs</a></span><span class="op">(</span><span class="va">res1</span><span class="op">)</span>
<span class="co">#&gt;    FLAG STUDY   TVKA  TVV2    TVCL    TVV3     TVQ      V3       Q BLQ CYCLE</span>
<span class="co">#&gt; 1:    0     1 0.1812 0.042 0.72457 0.17848 2307400 0.17848 2307400   0     1</span>
<span class="co">#&gt;    PART PROFDAY TIMEUNIT   model nmout</span>
<span class="co">#&gt; 1:    1       1    Hours xgxr001  TRUE</span></code></pre></div>
<p>Let’s take a look at what is in the <code>res1.id</code> generated above. It is a mix of variables that vary at subject level and variables that are constant across the full dataset.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">res1.id</span><span class="op">)</span>
<span class="co">#&gt; [1] 150  26</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">res1.id</span>,<span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;    ID FLAG STUDY   TVKA  TVV2    TVCL    TVV3     TVQ     KA    V2      CL</span>
<span class="co">#&gt; 1: 31    0     1 0.1812 0.042 0.72457 0.17848 2307400 0.1812 0.042 0.72457</span>
<span class="co">#&gt; 2: 32    0     1 0.1812 0.042 0.72457 0.17848 2307400 0.1812 0.042 0.72457</span>
<span class="co">#&gt;         V3       Q BLQ CYCLE DOSE PART PROFDAY WEIGHTB   eff0 TIMEUNIT TRTACT</span>
<span class="co">#&gt; 1: 0.17848 2307400   0     1    3    1       1  87.031 56.461    Hours   3 mg</span>
<span class="co">#&gt; 2: 0.17848 2307400   0     1    3    1       1 100.620 45.096    Hours   3 mg</span>
<span class="co">#&gt;    trtact   model nmout Cmax</span>
<span class="co">#&gt; 1:   3 mg xgxr001  TRUE    0</span>
<span class="co">#&gt; 2:   3 mg xgxr001  TRUE    0</span></code></pre></div>
<p><code>findCovs</code> has a counterpart in <code>findVars</code> which finds variables that do vary within constant values of optional <code>cols.id</code> columns. To get only the ones that vary within the dataset (i.e. they are truely subject-level variables and not say a study number if we only have one study), we can do</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res1.id2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findVars.html">findVars</a></span><span class="op">(</span><span class="va">res1.id</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">res1.id2</span><span class="op">)</span>
<span class="co">#&gt; [1] 150  10</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">res1.id2</span>,<span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;    ID     KA    V2      CL DOSE WEIGHTB   eff0 TRTACT trtact Cmax</span>
<span class="co">#&gt; 1: 31 0.1812 0.042 0.72457    3  87.031 56.461   3 mg   3 mg    0</span>
<span class="co">#&gt; 2: 32 0.1812 0.042 0.72457    3 100.620 45.096   3 mg   3 mg    0</span></code></pre></div>
<p><code>findVars</code> supports the cols.id argument too. So you can use <code><a href="../reference/findVars.html">findVars(res1,cols.id="ID")</a></code> to find variables that are non-constant within (at least one value of) ID. <code>cols.id</code> can be of arbitrary length.</p>
<p>Of course, we most often know what covariates or other subject-level variables to look at, and we would not search for them after running a nonmem model. But in the situation where you are looking at someone else’s work or you are doing a meta analysis across models where the data has been coded slightly differently, these simple tools can be very useful. Or if you like writing generic wrapper functions, you may find this very handy. Also, remember that if a variable is returned by these functions, you know that they fullfill the variability requirement. We know that variables in <code>res1.id</code> above do not vary within <code>ID</code>, meaning that no <code>ID</code> has more than one value of the variable. <code>NA</code> counts as any other value, so if a value is returned for subject in <code>res1.id</code>, this subject does not have <code>NA</code>’s in <code>res1</code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
