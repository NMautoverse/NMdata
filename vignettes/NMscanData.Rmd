---
title: "NMscanData"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{get-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r,setup}
library(NMdata)
library(ggplot2)
```

# Introduction
Getting data from R to Nonmem and back can be tedious and time
consuming. The way data is exported from Nonmem means that a few
tables may have to be combined, and then some variables may still be
missing (like character variables which may be in the input data
file). Most modellers develop some habits over time to avoid some
issues. But still, it may be time demanding even for experienced
modellers to pick up a model developed by someone else or by
themselves earlier in their career just because they need to
understand what data exported and how. This vignette focuses on how
NMdata provides a very general solution for what needs to be trivial:
get a dataset out of a Nonmem run. And general means that it will work
out of the box 
in as many cases as possible. It will do its best to understand how
the data can be read and combined, (ideally) regardless of the way the
model was written.

In brevity, the most important steps are

- Read and combine output tables
- If wanted, read input data and restore variables that were not
  output from the nonmem model
- If wanted, also restore rows from input data that were disregarded
  in Nonmem (e.g. observations or subjects that are not part of the
  analysis).
  
It should not be to hard to do. But with the large degree of
flexibility Nonmem offer, there are a lot of caveats to be aware of,
again especially if you didn't write the model by your own standards.

# Get started
Try NMscanData on any model:
```{r,eval=TRUE}
res1 <- NMscanData(NMdata_filepath("examples/nonmem/xgxr001.lst"))
res1[,trtact:=reorder(trtact,DOSE)]
res1.mean <- res1[EVID==0,.(gmPRED=exp(mean(log(PRED)))),by=.(trtact,NOMTIME)]
ggplot(res1[EVID==0])+
geom_point(aes(TIME,DV))+
## stat_summary(aes(x=NOMTIME,y=PRED),fun.y=function(x)exp(mean(log(x))),geom="line")+
geom_line(aes(NOMTIME,gmPRED),data=res1.mean)+
scale_y_log10()+
facet_wrap(~trtact)+
labs(x="Hours since administration",y="Concentration (ng/mL)")
```

Contains model predictions, and character, i.e. input and output.

Notes on the dataset.

Covariates

## Recover rows

## The row identifier
The row identifier is not needed for NMscanData to run and in most
cases succesfully and correctly complete all the steps above. However,
the most robust way is to include a unique row identifier in both
input and at least one full-length output table.




## The building blocks
The lst file was scanned for output tables, and they were all read
(including interpreting the possible firstonly option). The input data
has been used based on the DATA and INPUT sections of the control
stream. 



### Read all output data

### Input data means the data as used by Nonmem
You may already have thought about this for a while reading this
vignette. Nonmem doesn't read the variable or column names from the
input dataset. Names are assigned in the control stream. Moreover,
some columns may be dropped, and rows can be filtered using IGNORE and
ACCEPT conditions. NMdata has functions to interpret this, and to read
a dataset as interpreted by a nonmem model, point NMtransInput to the
model.



