* NMdata todo
#+TODO: TODO(t) WAIT(w) DONE(d)
# :PROPERTIES:
:LOGGING: nil
  :END:
** Design
*** TODO [#B] deprecate "default" option in NMdataConf
    has no benefit over NULL, so redundant and prevents the use of "default" as an actual param value.
*** DONE Allow for say input.txt/output.txt
**** NMtransInput
*** DONE Support for return as tibble or whatever
Could we use an option, NMdata.return="dplyr::as.tibble" which could then be
reached and applied from within NMdata? It would have to not create extra
dependencies. This solution is being tested on pmxtricks.
*** DONE Where does NMcode2R belong?
It is needed in NMdata but should it be exported from NMdata?
Conclusion: export from pmxtricks, internal in NMdata.
*** DONE Check assign by ref inside package
 copyOrNot <- function(data){
     data[,newcol:=1]
     }
With load_all():
> dt1 <- data.table(a=1)
> dt1
   a
1: 1
> r1=copyOrNot(dt1)
> dt1
> dt1
   a newcol
1: 1      1
*** DONE [#B] messageWrap internal/external
    This is called track.msg
    
    The mentioning of where a message comes from is only useful if a
    function is called from other functions. Possible to distinguish
    somehow?
** New functions
*** TODO function to add variables to $TABLE
**** Which $TABLE to add to?
*** TODO [#B] NMfreezeModels                                    :newFunction:
    Remember to add chmod and describe that only a flat dir structure is supported so far
*** DONE function to replace file name extension - fnExtension
*** DONE summary.NMdata
*** DONE Summary of the columns - NMinfo
    right now hidden in metadata
*** DONE Summary of tables - NMinfo
*** TODO [#B] A function that defines NULL variables
    Risk now is that arguments are set to NULL
    Export to parent. Not sure check allows though...
** Function improvements
*** NMcheckColNames
**** return input column names and Nonmem interpretation for user to spot errors
**** Bad name, what could we call it?
*** cc - create character vector function
*** NMgenText
**** TODO [#B] checks: duplicate column names
**** TODO [#B] test if a synonym was used. Give warning or msg if not
**** TODO [#B] test if variables are used in more than one arg
like copy, synonym etc. Doesn't make sense to use in more than one.
*** findCovs
*** compareCols
**** DONE Bug - overview of columns is given twice
 compareCols(ex.001,ex.002,ex.005,diff.only=T) %>% print(topn=100)

No, they werent. It was the print call. But one change was made. now quiet=T suppresses all the info, so in the example above, use quiet=T to print a subset with print(topn=...).
**** DONE scope argument
     This is called columns.wanted

     Sometimes we are interested in specific columns. List these and only
these in the same order as requested. An inversion option could be
helpful. Only list other columns than the scope.
**** DONE rows are not being sorted correctly.
     Seems not to prioritize columns that only exist in one of the
     data.tables.
**** DONE Bug for diff.only=FALSE
*** egdt
**** DONE BUG the tmp by col has to be removed before reporting dims
**** DONE Report dims(df1,df2,result) unless quiet
*** listMissings                                        :v0_0_11:newFunction:
List missing elements
For specific columns, look for missing elements (NA, "", length(x)==0
in case of lists?). Tabulate and list. 
**** TODO Align reporting with NMcheckData?
**** TODO dcast summary when using by
This is quite powerfull:
 dcast(missings[,.N,by=.(STUDYID,variable)],variable~STUDYID)
***** Would be even better to have zeros where columns are found and there are no NA's. 
***** Include "number of rows" in table.
      
**** DONE listMissings test                                         :v0_0_11:
     CLOSED: [2022-02-04 Fri 16:16]
*** TODO [#B] NMasNumeric                                       :newFunction:
Error if not convertible and not NA or ""? "b" should be an error right?
*** TODO [#B] NMsummarizeData Summarize data with nonmem in mind. :newFunction:
**** Number of doses and obs per subj
**** Dist of DV
**** Covariates
**** Has to take a by arg
*** TODO [#A] NMcreateDoses Generate dosing schedule with loading, ADDL etc :newFunction:
    This is available as a suitcase function
*** TODO [#B] Function for complex dosing regimens              :newFunction:
*** TODO [#B] Function to unfold ADDL/II doses to multiple rows :newFunction:
*** mergeCheck
**** TODO [#B] Add at least number of NA's to message about what was added
Probably add class too.
Number of unique combinations of by? This seems too advanced
4|3|2 -> 4
Numer of NA's in right and in result
**** DONE Deprecate df1 and df2 arguments                           :v0_0_11:
**** DONE Warning if NA in by columns                               :v0_0_11:
**** DONE merge in try                                              :v0_0_11:
     If the merge actually fails, we want to prepend something to the
     data.table::merge error.
**** TODO [#B] second merge in try
If first merge isn't accepted, the second merge can fail. Or is it
because by and by.x+by.y are handled differently the second time? Clen this.
**** TODO [#B] Check that by or by.x+by.y were supplied
**** TODO [#B] derive by.x and by.y from by and by.x+by.y and then use by.x and by.y
     That will make the code clearer because we will know exactly how
     the merge is done.
**** DONE Test the check for row duplications
*** NMcheckData
**** TODO Support for col.dv.
     Preferably of length>1
**** TODO The summary should take a by argument
**** TODO Define a NMfindings class and create a summary function?
**** DONE Note when installing                                      :v0_0_11:
     Note: ... may be used in an incorrect context at NMcheckData.R:290 
     Solution: listEvents must have a args.fun rather than ...
     This will be cleaner anyway. But it will require a do.call.
**** DONE Find previously used code
**** DONE Implement checks in pmxtricks todo
**** TODO [#B] Implement more checks
https://doi.org/10.1208/s12248-012-9387-9
**** Additional checks
***** DONE Having NA in FLAG is dangerous
      It makes it unclear how the filter will work
***** DONE AMT>0 for EVID=0 is not allowed (I believe)
**** DONE check for commas in character columns
Implement in same style as checks of cols.num
**** column names
***** DONE duplicate column names
***** DONE warning if duplicated column names
      Other checks may be affected
***** DONE special characters not allowed in column names
**** DONE If col.row included, col.row increasing, unique
**** DONE For elements that are not numeric, are the characters accepted (like na.char=".")
**** DONE Duplicated events
     Remember, this is between EVID 3 or 4's. What is being done for
     checking for non-decreasing time to keep track of this should be
     reused.
**** Inform what columns Nonmem can use
***** Which are numeric
***** Which are before the first non-numeric
**** DONE NA TIME
**** CANCELED actual time since first dose vs Nominal time since first dose
**** CANCELED actual time since last dose vs Nominal time since nominal dose
**** DONE all subjects have doses?
**** DONE All subjects have observations?
**** Negative actual time (since first or previous dose) when corresponding nominal time is neg
**** DONE Negative TIME
**** negative doses
**** DONE negative dose times
**** negative concentrations
**** CANCELED Nomminal dose vs actual dose
**** DONE positive AMT for !EVID%in%c(1,4)
**** DONE NA EVID, EVID in 1:4
**** zero doses (will fail in nonmem)
**** DONE TIME increasing for subjects between EVID 3 or 4
**** tests of text file
***** A field can't contain more than 24 characters
**** DONE cols.num split on other columns                           :v0_0_11:
Many variables are only expected to exist for say samples. Example:
LLOQ can very well be missing for doses. And the check may depend on
study, compound etc too. So we need to split or subset data for the
check. Maybe check in a subset and expect NA in the rest?
**** TODO [#B] Checks for presense of II and ADDL don't report dependence
     If one is present, presence of the other is tested. If not found,
     it says "II Column not found". Would be helpful to know that it
     is because ADDL is found.
**** DONE Check for , in character column contents not working
**** DONE Checks for availability
I ran it on an immature dataset and got this error:
Error in `[.data.table`(data, , `:=`((cols.num), lapply(.SD, NMasNumeric)),  : 
  .SDcols should be column numbers or names
**** DONE ID and row identifier must not start with a zero
     That would ruin merging if Nonmem prints as a double or integer
**** DONE Check individual columns with NMisNumeric instead of running NMasNumeric on everything
**** DONE check RATE, SS
**** DONE Check ADDL, II
**** DONE Support for file argument (control stream)
**** DONE Element-wise NMisNumeric
There are two distinct uses of NMisNumeric. Column-wise and
element-wise. When checking for NMisNumeric, columns that must be
numeric should be using
**** DONE Only check for special characters in colnames for numeric columns
     Applies to other colname checks too?
**** TODO [#B] Requirements to DV for EVID==2 and EVID==3?
**** DONE Add col.row to findings
**** DONE Check splits of cols.num                                  :v0_0_11:
**** DONE Document splits of cols.num                               :v0_0_11:
**** DONE Document col.cmt                                          :v0_0_11:
*** NMcheckDataFile
**** DONE Check all columns as cols.num                             :v0_0_11:
**** DONE Return data, summary and more                             :v0_0_11:
**** TODO [#B] Check whether NA's are coded with .'s
*** NMextractDataFile
**** DONE Add support for windows absolute paths
     I don't think this was ever an issue. The regular expression used
     should match both unix and windows absolute paths.
*** NMwriteSection
**** DONE Check if any files matched before running lapply
**** TODO [#B] When using list.files, give overview of matches by expression and by data.file
**** DONE Bug in data.file argument
     Error in FUN(X[[i]], ...) : file.exists(file0) is not TRUE
**** DONE Support for file name pattern in dir
     code available in recent script
**** DONE Support for multiple sections
Instead of the section argument, NMreplacepart must accept newlines as a named
list.
*** NMextractText
**** TODO [#B] reduce lines and text to one argument
The information is sufficient when taking into account the linesep
arguement. If length(lines) and linesep is given, a warning must be
issued. Once done, NMgetSection must be updated as well.
*** NMscanInput
**** DONE BUG tabs in column names?
    REC\t  ID\t     TIME    TAD\t DOSE\t AMT\t RATE CMT  DV\t MDV\t EVID

Included a gsub("\t"," ",lines)
**** TODO [#B] Model path (mod/lst, whichever used) should be available in meta data
**** TODO [#B] argument char.comment.inp
     User may write say # (input_data_debug.csv) in front of column
     names in csv and then use IGNORE=# to avoid them in Nonmem. We
     should support the same arg to remove the char from the input
     column name. However, only relevant if column names are not
     translated.
**** DONE Get number of subjects as before filtering
Challenge is that the filters are applied before the column names are
changed. So we need access to the old data and know what column to
look at - called col.id after the translations.
**** Pseudonyms A=B
***** TODO [#C] A=B synonym labels should be matched against reserved variable names
***** DONE copy data to have acces using both names
****** Edit these lines in NMscanInput
       ## For now, we just take the first name used in A=B labeling. 
       nms <- sub(".*=(.*)","\\1",nms)
***** DONE Names of variables must be taken from lst, not mod
 mod should only be used for path to dataset.
***** DONE Add support for absolute paths
***** DONE SKIP like DROP
***** TODO [#B] TIME and related columns
 I still don't really understand the documentation on this, but it doesnt seem
 too hard to implement. It should NOT only be interpreted when the A=B format is used in
 $INPUT. If something is called TIME, it must be checked for format.
***** DONE .mod files should be accepted as the file argument
      Maybe file can be missing/NULL if file.mod is given.
*** NMtransFilters
**** DONE Report translation in NMmeta
**** DONE Replace single = with ==
According to the manual single = can be used for comparisons. This is not and
should not be translated by NMcode2R.
**** DONE $INPT is an alias for $INPUT
**** TODO [#B] Implement NULL
The way to change the missing string in nonmem. User could use
NULL=NAN which would mean that NA should be interpreted as NA in R.
**** TODO [#B] Implement or at least detect RECORDS
A way to limit rows read into nonmem
*** NMtransInput
    Translate column names according to Nonmem.
**** DONE [#B] Add comparison column input-nonmem
***** if input!=nonmem,
***** nonmem %in% all(input)
***** tolower(nonmem)==tolower(input) OK
***** diff
***** off
*** NMscanTables
**** TODO [#B] include meta data as NMinfo
**** DONE Lastonly does the same as firstonly
*** NMscanData
**** TODO [#B] Simplify timestamp warnings
     When .mod is newer than .lst and or tables, reduce to one warning
     summarizing both findings.
**** DONE nmout and model must not overwrite existing
     The can still overwrite, but a warning is thrown
**** DONE Check that no new values of col.row are found in output
**** DONE Test for disjoint ID's
     If ID's are disjoint, it's actually really easy to make a new ID
     and use that for merging firstonly. But only if a row identifier
     is used. If not the same new ID is to be added to the
     firstonly. This will need testing.
**** DONE Move time checks up
Now, if number of rows don't match in input and output, the user don't
get warnings about time. This is bad because updates to input data is
a likely reason.
**** DONE Add support for merge.by.row="ifAvailable"
**** DONE Make sure all options in NMdataConf are documented
**** DONE input file name in meta columns
***** table column should be called file
**** DONE intro translate.input argument
**** DONE method.combine to merge.by.row
     Since we only have and will only have two methods, this should be
     a binary switch between the methods.
**** DONE Check if col.row is being modified in Nonmem.
**** TODO [#B] Limitation: tables with EXCLUDE_BY
**** DONE Limitation: FIRSTLASTONLY
**** DONE Implement recoverRows using mergeByFilters
**** TODO [#B] Add support for col.row of length>1
**** DONE Consistent behaviour when missing data arguments
***** use.input (default)
****** Means that output data will be merged onto input data
****** If input data is missing or merge not possible, give warning
****** if only firstonly data available, do the merge if possible
***** mergeByFilters (defult in future?)
***** Only allowed if use.input=TRUE
***** Means that we will translate NM filters and cbind rather than using a row identifier.
***** If the filters go wrong, give error
***** Firstonly (FO) data can only be used if ID is both input and FO table
  We can implement taking the sequence of IDs from input and restore
  ID's from that
**** DONE Improve summary of what tables were used and how.
Right now it only says if input or output. Table name would be helpful.
**** TODO [#B] Support for no ID, no ROW in firstonly tables
If mergeByFilters we can take the sequence of ID in the input
data. But what if an ID comes back? I think a record is in FIRSTONLY
whenever ID changes, but test this.
**** TODO [#B] Check if ID has been corrupted by output format
check if variables are consistent within ROW: ID (others?) This is
fatal and will happen when using long ID's and non-matching format
when writing tables from Nonmem.
**** TODO [#B] New argument to define columns to read from input data
ID should be default. Maybe TIME too?
**** DONE Run NMorderColumns in the end
Remember to use what we know about col.row. 
**** DONE source for nmout and model must be internal
in var table 
**** TODO [#B] report tables that are not used
See xgxr013.lst in test_NMscanData. A firstonly table cannot be included. This
is not visible in summary because summary is based on tables in returned
data. It should be based on tables in meta$tables.
*** NMwriteData
**** DONE BUG NA's are not .
does fwrite use args.fwrite at all?
**** DONE Separate generation of INPUT text into new function
     Called NMgenText
**** DONE Bug in inclusion of filename in text
     See poster example
**** TODO [#B] Include a randomly generated ID in meta data that we can check files against?
**** DONE Add support for custom fwrite arguments
**** DONE When writing a CSV, write meta data to separate file
**** DONE Support for pseudonyms
     It's called nm.rename. You can only add A in A=B.
**** DONE Check if character variables contain commas
This will cause trouble when writing csv
**** DONE Use fwrite rather than write.csv
**** TODO [#B] Improve support for custom IGNORE/ACCEPT statements
Nested statements
**** DONE Returned text should be a list of sections.
Ultimately, NMreplacePart must accept this as argument.
**** DONE The Nonmem instructions should not include character variables
**** DONE Include an argument to do =DROP
This will only affect the instructions to pass into Nonmem. If =DROP
is on a character variable, subsequent numerics can still be used in
Nonmem.
**** DONE print out dropped variables? 
Not warning. Warning if standard variable?
*** NMordercolumns
**** DONE Remove check for standard columns
     This is now done in NMcheckData instead
**** DONE Don't warn about missing SS, ADDL, II
**** DONE Polish
*** flagsAssign
**** TODO [#A] We need to work in IDhasNoObs and IDhasNoDos 
This likely means a restructure so all tables have to be given
together and these subject-level flags are set across EVID after 
**** DONE check for whether there are any contents in data - just warning and return nothing
**** DONE implement grp.incomp as in flagsCount
**** DONE Only give message about overwriting FLAG/flag if non-NA values are present
**** DONE Improve messages at each FLAG coding
**** DONE Make sure we arrange back to original order
**** DONE Introduce a way to apply to a subset only
This could be EVID==0 or maybe one study in a meta analysis

It's fairly easy to implement. Paste in front of the expression.use column.
**** DONE Can we assign FLAG=0, flag=Dosing to EVID==1?
     Or is FLAG==0 reserved?
use flagsAssign(data,subset.data="EVID==1",flagc.0="Dosing")
*** flagsCount
**** DONE bug in 0.0.9: Nobs.disc.cum ignores by
**** DONE OK respect decreasing or increasing order.flags
**** DONE add .cum of N and Nobs
**** DONE add argument to name "all available data" in table. 
**** DONE Add check on EVID - who wants to mix these?
**** TODO [#B] allow skipping and disabling flags.
***** For this we will need additional two columns - Nobs.matched and N.(entirely.)matched
**** TODO [#B] The function could paste an explained overview to the terminal
**** DONE Add save argument to align with other functions
*** NMdataConf
**** TODO [#B] Add col.id. Generally, support for custom col.id may be missing.
**** TODO [#B] Add na.strings
     Used in NMisNumeric and NMcheckData
**** DONE test that function evaluation does not depend on global env
**** DONE Add support for add.name
**** DONE use.input
**** DONE recover.rows
**** DONE use.rds
**** DONE quiet
**** DONE col.row
This is two steps. 
***** A method.merge argument must be introduced in NMscanData
***** col.row can be non-NULL even if using cbind for combining data
**** DONE order.columns
*** stampObj
**** CANCELED Include output filename in stamp
This belong in write functions. stampObj does support extra
arguments. NMdata calls this "writtenTo".
*** summary.NMdata
**** Rethink and tidy up message
***** DONE Combine first two tables
***** DONE Add number of rows
***** DONE Add result row
****** Number of columns has 0-2 extra columns
** Tests and documentation
*** Cheat sheet
**** Outline
***** Intro
***** Data preparation
***** Finalize and write for NONMEM
***** Read and combine input and output data
***** Debug
***** Traceability
**** DONE Flag example
*** Tests
**** DONE Test NMdataConf(file.mod=identity)
**** DONE [#B] NMscanData with copy in $INPUT
     Especially, look at colnames.input
*** Examples
**** DONE renameByContents example
*** Vignettes
*** pkgdown
**** TODO Add bug list
**** TODO Rename menu items
**** TODO Automate Function overview from tags
** Discussion
*** recoverRows can mean mix of variable interpretations
If recoverRows and a variable is changing interpretation from input to
output, the resulting table will carry two distinct variables
depending on nmout TRUE or FALSE.
** Prepare first CRAN release
*** DONE Get overview of functionality contents
*** DONE Remove all debug arguments
*** DONE Polish NMwriteData
*** DONE Polish NMordercolumns
*** DONE Support for tibbles
*** DONE Improve flagsAssign messages at each FLAG coding
*** DONE Read through all documentation
*** DONE Function family DataRead for NMscanData and others
*** DONE Rename DataWrangling to DataCreate
*** DONE NMtransFilters - read through and clean comments
*** DONE messageWrap cites the messages from within
    Should be possible to make say a warning seem like it's coming
    from one level up.
*** DONE vignette on data set creation
*** DONE vignette on FAQ
*** DONE Fix NMscanData messages to be just one.
*** DONE Vignettes should mostly use data.frame's.
*** DONE Release 0.0.6
**** DONE Look for file.mod option
**** DONE Release 0.0.6.1
 with only diff from 0.0.6 that it returns data.frames by default
*** DONE check of mtimes relative to each other
*** DONE Test input with duplicated column names
*** DONE summary.NMdata: no visible global function definition for '.'
replaced a couple of calls to . by list. Not sure why this happens for
exactly these uses of ".". Anyway, no consequence to functionality.
*** DONE Drop filepath_NMdata
*** DONE Release 0.0.7
**** DONE Go through all manuals and update according to new config system
**** Update vignettes
***** DONE NMscanData
***** DONE FAQ
***** DONE DataCreate
**** DONE document data objects
See how it's done in pmxtricks.  This is done. However, the datasets are not
exported so it's not very important.
** Misc
