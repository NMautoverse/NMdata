% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
  8pt,
  ignorenonframetext,
  aspectratio=169]{beamer}
\usepackage{pgfpages}
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{: }
\setbeamercolor{caption name}{fg=normal text.fg}
\beamertemplatenavigationsymbolsempty
% Prevent slide breaks in the middle of a paragraph
\widowpenalties 1 10000
\raggedbottom
\setbeamertemplate{part page}{
  \centering
  \begin{beamercolorbox}[sep=16pt,center]{part title}
    \usebeamerfont{part title}\insertpart\par
  \end{beamercolorbox}
}
\setbeamertemplate{section page}{
  \centering
  \begin{beamercolorbox}[sep=12pt,center]{part title}
    \usebeamerfont{section title}\insertsection\par
  \end{beamercolorbox}
}
\setbeamertemplate{subsection page}{
  \centering
  \begin{beamercolorbox}[sep=8pt,center]{part title}
    \usebeamerfont{subsection title}\insertsubsection\par
  \end{beamercolorbox}
}
\AtBeginPart{
  \frame{\partpage}
}
\AtBeginSection{
  \ifbibliography
  \else
    \frame{\sectionpage}
  \fi
}
\AtBeginSubsection{
  \frame{\subsectionpage}
}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={ NMdata: A fast R package for efficient data preparation, consistency-checking and post-processing in PK/PD modeling},
  pdfauthor={Philip Delff},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\newif\ifbibliography
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\usepackage{adjustbox}
\ifluatex
  \usepackage{selnolig}  % disable illegal ligatures
\fi

\title{\includegraphics[width=1in,height=\textheight]{image_2021_06_07T20_32_08_398Z.png}\\
NMdata: A fast R package for efficient data preparation,
consistency-checking and post-processing in PK/PD modeling}
\author{Philip Delff}
\date{June, 2021}

\begin{document}
\frame{\titlepage}

\begin{frame}
\end{frame}

\begin{frame}{Outline}
\protect\hypertarget{outline}{}
\tableofcontents[hideallsubsections]
\end{frame}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

\begin{frame}{What is NMdata?}
\protect\hypertarget{what-is-nmdata}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{block}{NMdata is}
\protect\hypertarget{nmdata-is}{}
An R package that can help

\begin{itemize}
\tightlist
\item
  Creating event-based data sets for PK/PD modeling
\item
  Keeping Nonmem code updated to match contents of datasets
\item
  Read all output data and combine with input data from Nonmem runs
\item
  supply output list file (.lst), and the reader is very flexible and
  automated
\end{itemize}

Designed to fit in to the user's setup and coding preferences

\begin{itemize}
\tightlist
\item
  NMdata comes with a configuration tool that can be used to tailor
  default behaviour to the user's system configuration and preferences.
\end{itemize}
\end{block}
\end{column}

\begin{column}{0.48\textwidth}
\begin{block}{NMdata is not}
\protect\hypertarget{nmdata-is-not}{}
\begin{itemize}
\item
  A plotting package
\item
  A tool to retrieve details about model runs
\item
  A calculation or simulation toolbox
\item
  A ``silo'' that requires you to do things in a certain way

  \begin{itemize}
  \tightlist
  \item
    No tools in NMdata requires other NMdata tools to be used
  \end{itemize}
\end{itemize}
\end{block}
\end{column}
\end{columns}

\[\vspace{.01in}\]

The data creation tools should be relevant independently of
estimation/simulation tool.
\end{frame}

\begin{frame}[fragile]{Motivation}
\protect\hypertarget{motivation}{}
\begin{itemize}
\item
  As large a potential pharmacometrics has for illuminating the unknown
  in drug development, it is dangerously technical.
\item
  I hate being stuck in leg work and having too little time for
  modeling, reflection, and understanding key questions. \texttt{NMdata}
  is a big help for me personally in freeing time to more high-level
  tasks.
\item
  During the first 2-3 years I spent in pharmacometrics, I must have
  spent half the time coding, desparately trying to get Nonmem to behave
  and to understand the properties of the estimates I obtained.
\item
  Most of us develop our own ways to avoid some of the many difficulties
  in this process. This takes a lot of time and is most often only
  because we don't have adequate tools at hand.
\item
  Being a fairly experienced R programmer, I generalized some of these
  methods and collected them in \texttt{NMdata}.
\item
  Almost every single line of code in the package is motivated by bad
  experiences. Errors, fear of errors, time wasted on debugging and
  double checking.
\item
  I have no intention of missioning these approaches to others. But if
  you find something interesting, feel free to take advantage.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Getting started}
\protect\hypertarget{getting-started}{}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(remotes)}
\KeywordTok{install\_github}\NormalTok{(}\StringTok{"philipdelff/NMdata"}\NormalTok{,}\DataTypeTok{upgrade=}\StringTok{"never"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(NMdata)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Welcome to NMdata. Best place to browse NMdata documentation is
## https://philipdelff.github.io/NMdata
\end{verbatim}

Three vignettes are available so far (see ``Vignettes'' tab when
visiting URL above):

\begin{itemize}
\tightlist
\item
  \href{https://philipdelff.github.io/NMdata/articles/DataCreate.html}{Data
  creation tools}
\item
  \href{https://philipdelff.github.io/NMdata/articles/NMscanData.html}{Automated
  and general reader of Nonmem data}
\item
  \href{https://philipdelff.github.io/NMdata/articles/NMdata-FAQ.html}{FAQ}
\end{itemize}

For a quick overview (after installation), do:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{help}\NormalTok{(}\DataTypeTok{package=}\StringTok{"NMdata"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

All functions and their arguments are documented in their help files.
\end{frame}

\hypertarget{data-set-creation}{%
\section{Data set creation}\label{data-set-creation}}

\begin{frame}[fragile]{Compare compatibility of data sets for rbind and
merge}
\protect\hypertarget{compare-compatibility-of-data-sets-for-rbind-and-merge}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{itemize}
\tightlist
\item
  In order to rbind or merge data sets, they must be compatible in
\item
  presence of columns, depending of desired outcome
\item
  equally importantly, the classes of the common columns.
\item
  compareCols provides an overview of these properties for any number of
  data sets.
\item
  By default, only descripancies are returned.
\item
  Using \texttt{diff.only=FALSE} will give the complete list of columns
  in the two datasets.
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
A slightly modified version of the \texttt{pk} dataset has been created.

\begin{itemize}
\tightlist
\item
  \texttt{CYCLE} has been removed, and
\item
  \texttt{AMT} has been recoded to character
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{compareCols}\NormalTok{(pk,pk.reduced)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Dimensions:
\end{verbatim}

\begin{verbatim}
##          data nrows ncols
## 1:         pk  1502    22
## 2: pk.reduced   751    21
\end{verbatim}

\begin{verbatim}
## 
## Overview of columns:
\end{verbatim}

\begin{verbatim}
##    column      pk pk.reduced
## 1:  CYCLE integer       <NA>
## 2:    AMT integer  character
\end{verbatim}

\vspace{12pt}

Before merging or stacking, we may want to

\begin{itemize}
\tightlist
\item
  recode \texttt{AMT} in one of the datasets to get the class we need
\item
  decide what to do about the missing \texttt{CYCLE} in one of the
  datasets
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Rename columns based on contents}
\protect\hypertarget{rename-columns-based-on-contents}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{block}{renameByContents}
\protect\hypertarget{renamebycontents}{}
\begin{itemize}
\tightlist
\item
  Nonmem almost entirely relies on numeric data values.
\item
  The source data will often contain character variables, i.e.~columns
  with non-numeric data values. We want to use these and other
  non-numerics in post-processing.
\item
  If the column names reflect whether the values are numeric, mistakes
  and double-checking can be avoided.
\item
  \texttt{renameByContents} renames columns if a function of their
  contents returns \texttt{TRUE}.
\end{itemize}
\end{block}

\begin{block}{\texttt{NMisNumeric}}
\protect\hypertarget{nmisnumeric}{}
\begin{itemize}
\tightlist
\item
  \texttt{NMisNumeric} is a function that tests if the contents are
  numeric to \texttt{Nonmem}.
\item
  Subject ID \texttt{"1039"} (character class) will be a numeric in
  Nonmem, \texttt{"1-039"} will not.
\item
  We invert that, and those that Nonmem cannot interpret as numeric
  become lowercase.
\end{itemize}
\end{block}
\end{column}

\begin{column}{0.48\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pk \textless{}{-}}\StringTok{ }\KeywordTok{renameByContents}\NormalTok{(}\DataTypeTok{data=}\NormalTok{pk,}
                       \DataTypeTok{fun.test=}\NormalTok{NMisNumeric,}
                       \DataTypeTok{fun.rename =}\NormalTok{ tolower,}
                       \DataTypeTok{invert.test =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{compareCols} shows that four columns were renamed:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{compareCols}\NormalTok{(pk.old,pk)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Dimensions:
\end{verbatim}

\begin{verbatim}
##      data nrows ncols
## 1: pk.old  1502    22
## 2:     pk  1502    22
\end{verbatim}

\begin{verbatim}
## 
## Overview of columns:
\end{verbatim}

\begin{verbatim}
##      column    pk.old        pk
## 1:   EVENTU character      <NA>
## 2:     NAME character      <NA>
## 3: TIMEUNIT character      <NA>
## 4:   TRTACT character      <NA>
## 5:   eventu      <NA> character
## 6:     name      <NA> character
## 7: timeunit      <NA> character
## 8:   trtact      <NA> character
\end{verbatim}

\normalsize
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Automated checking of merges}
\protect\hypertarget{automated-checking-of-merges}{}
\begin{itemize}
\tightlist
\item
  Merges are a very common source of data creation bugs.
\item
  As simple as they may seem, merges likely leave you with an unexpected
  number of rows, some repeated or some omitted.
\item
  \texttt{mergeCheck} is a wrapper of \texttt{merge} which only accepts
  the results if
\end{itemize}

\textbf{The rows that come out of the merge are the exact same as in one
of the existing datasets, only columns added from the second dataset}

\begin{itemize}
\item
  This limitation of the scope of the merge allows for a high degree of
  automated checks of consistency of the results.
\item
  This is not to say that merges beyond the scope of \texttt{mergeCheck}
  are relevant or necessary. But if \texttt{mergeCheck} covers your
  needs, it's a real time saver in terms of automated checks that you
  are getting what you expect.
\end{itemize}

\textbf{mergeCheck is not a new implementation of merge. It's an
implementation of checks.}

\begin{itemize}
\item
  \texttt{mergeCheck} uses \texttt{merge.data.table}. The addition is
  the checks that the result is in accordance with the restrictions.
  This means
\item
  The order of rows in the resulting data is always the same as the
  first dataset supplied.
\end{itemize}

Does that make it slower?

\begin{itemize}
\tightlist
\item
  If you don't use data.table already, \texttt{mergeCheck} is likely to
  be way faster than what you use already.
\item
  The checking overlay should be neglegible.
\item
  If checks fail, an additional merge is done to help user identify
  problems. This may cost significant additional time but is likely to
  save you coding and (at least) the same calculation time anyway.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{mergeCheck}
\protect\hypertarget{mergecheck}{}
\framesubtitle{Example: Would your standard checks of merges capture this?}

Say we want to add a covariate from a \texttt{dt.cov}. We expect the
number of rows to be unchanged from \texttt{pk}. \texttt{mergeCheck}
requires that we get all and only the \emph{same} rows:

\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{block}{Without \texttt{mergeCheck}}
\protect\hypertarget{without-mergecheck}{}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\# The resulting dimensions are correct}
\NormalTok{pk4 \textless{}{-}}\StringTok{ }\KeywordTok{merge}\NormalTok{(pk,dt.cov,}\DataTypeTok{by=}\StringTok{"ID"}\NormalTok{)}
\KeywordTok{dims}\NormalTok{(pk,dt.cov,pk4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      data nrows ncols
## 1:     pk  1502    22
## 2: dt.cov   150     2
## 3:    pk4  1502    23
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\# But we now have twice as many rows for this subject}
\KeywordTok{dims}\NormalTok{(pk[ID}\OperatorTok{==}\DecValTok{31}\NormalTok{],pk4[ID}\OperatorTok{==}\DecValTok{31}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             data nrows ncols
## 1:  pk[ID == 31]    10    22
## 2: pk4[ID == 31]    20    23
\end{verbatim}
\end{block}
\end{column}

\begin{column}{0.48\textwidth}
\begin{block}{\texttt{mergeCheck} throws an error}
\protect\hypertarget{mergecheck-throws-an-error}{}
\ldots and suggests what is wrong \footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{try}\NormalTok{(}\KeywordTok{mergeCheck}\NormalTok{(pk,dt.cov,}\DataTypeTok{by=}\StringTok{"ID"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Rows disappeared during merge.
\end{verbatim}

\begin{verbatim}
## Overview of dimensions of input and output data:
##         data nrows ncols
## 1:        pk  1502    23
## 2:    dt.cov   150     2
## 3: merged.df  1502    24
\end{verbatim}

\begin{verbatim}
## Overview of values of by where number of rows in df1 changes:
##     ID N.df1 N.result
## 1:  31    10       20
## 2: 180    10        0
\end{verbatim}

\begin{verbatim}
## Error in mergeCheck(pk, dt.cov, by = "ID") : 
##   Merge added and/or removed rows.
\end{verbatim}
\end{block}
\end{column}

\normalsize
\end{columns}

\begin{block}{Conclusion}
\protect\hypertarget{conclusion}{}
If you only want to add columns by a merge, \texttt{mergeCheck} does all
the necessary checks for you.
\end{block}
\end{frame}

\begin{frame}[fragile]{Exclusion flags}
\protect\hypertarget{exclusion-flags}{}
\framesubtitle{Keep track of data exclusions - don't discard!}

\begin{itemize}
\item
  It is good practice not to discard unwanted records from a dataset but
  to flag them and omit them in model estimation.
\item
  When reporting the analysis, we need to account for how many data
  records were discarded due to which criteria.
\item
  The implementation in \texttt{NMdata} is based on sequentially
  checking exclusion conditions.
\item
  The information is represented in one numerical column for Nonmem, and
  one (value-to-value corresponding) character column for the rest of
  us.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{FlagsAssign}
\protect\hypertarget{flagsassign}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{itemize}
\item
  \texttt{flagsAssign} applies the conditions sequentially and by
  increasing or decreasing value of \texttt{FLAG}.
\item
  \texttt{FLAG=0} means that none of the conditions were met and row is
  kept in analysis. This cannot be changed.
\item
  You can use any expression that can be evaluated \emph{row-wise}
  within the data.frame. In this case, \texttt{BLQ} has to exist in
  \texttt{pk}.
\item
  If you need to evaluate a condition based on multiple rows (say
  inadequate dosing history for a subject), do that first, and include a
  column representing this condition.
\item
  In \texttt{Nonmem}, you can include \texttt{IGNORE=(FLAG.NE.0)} in
  \texttt{\$DATA} or \texttt{\$INFILE}.
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dt.flags \textless{}{-}}\StringTok{ }\KeywordTok{fread}\NormalTok{(}\DataTypeTok{text=}\StringTok{"FLAG,flag,condition}
\StringTok{10,Below LLOQ,EVID==0\&BLQ==1}
\StringTok{100,Negative time,EVID==0\&TIME\textless{}0"}\NormalTok{)}

\NormalTok{pk \textless{}{-}}\StringTok{ }\KeywordTok{flagsAssign}\NormalTok{(pk,}\DataTypeTok{tab.flags=}\NormalTok{dt.flags,}\DataTypeTok{subset.data=}\StringTok{"EVID==0"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Coding FLAG = 100, flag = Negative time
\end{verbatim}

\begin{verbatim}
## Coding FLAG = 10, flag = Below LLOQ
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pk[EVID}\OperatorTok{==}\DecValTok{1}\NormalTok{,FLAG}\OperatorTok{:}\ErrorTok{=}\DecValTok{0}\NormalTok{]}
\NormalTok{pk[EVID}\OperatorTok{==}\DecValTok{1}\NormalTok{,flag}\OperatorTok{:}\ErrorTok{=}\StringTok{"Dosing"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{\texttt{flagsCount}}
\protect\hypertarget{flagscount}{}
\begin{itemize}
\item
  An overview of the number of observations disregarded due to the
  different conditions is then obtained using \texttt{flagsCount}:
\item
  \texttt{flagsCount} includes a \texttt{file} argument to save the the
  table right away.
\end{itemize}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{flagsCount}\NormalTok{(}\DataTypeTok{data=}\NormalTok{pk[EVID}\OperatorTok{==}\DecValTok{0}\NormalTok{],}\DataTypeTok{tab.flags=}\NormalTok{dt.flags)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  flag N.left Nobs.left N.discard N.disc.cum Nobs.discard Nobs.disc.cum
## 1: All available data    150      1352        NA          0           NA             0
## 2:      Negative time    150      1350         0          0            2             2
## 3:         Below LLOQ    131       755        19         19          595           597
## 4:       Analysis set    131       755        NA         19           NA           597
\end{verbatim}

Now pick the columns you want and format your table for the report.
\end{frame}

\hypertarget{finalize-data-for-nonmem}{%
\section{Finalize data for Nonmem}\label{finalize-data-for-nonmem}}

\begin{frame}[fragile]{Advice: always include a unique row identifier}
\protect\hypertarget{advice-always-include-a-unique-row-identifier}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{block}{Why}
\protect\hypertarget{why}{}
A unique identifier is needed in order to

\begin{itemize}
\item
  Track rows in analysis data back to source data
\item
  Reliably combine (by merge) output with input data
\end{itemize}
\end{block}

\begin{block}{The identifier should be}
\protect\hypertarget{the-identifier-should-be}{}
\begin{itemize}
\item
  Numeric
\item
  For Nonmem to be able to read it
\item
  Integer
\item
  To avoid risk of rounding
\item
  It is \emph{not} a problem if represented as a \texttt{double} in
  \texttt{R}
\item
  Increasing
\item
  Not strictly necessary
\item
  Avoid confusion
\item
  May be useful for post-processing to have a single column to order by
\end{itemize}
\end{block}
\end{column}

\begin{column}{0.48\textwidth}
\begin{block}{Sort rows and add a row counter with \texttt{data.table}}
\protect\hypertarget{sort-rows-and-add-a-row-counter-with-data.table}{}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{setorder}\NormalTok{(pk,ID,TIME,EVID)}
\NormalTok{pk[,ROW}\OperatorTok{:}\ErrorTok{=}\DecValTok{1}\OperatorTok{:}\NormalTok{.N]}
\end{Highlighting}
\end{Shaded}
\end{block}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{NMorderColumns}
\protect\hypertarget{nmordercolumns}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\vspace{12pt}

The order of columns in Nonmem is important for two reasons.

\begin{itemize}
\tightlist
\item
  Character in a variable read into Nonmem will make the run fail
\item
  The number of variables you can read into Nonmem is restricted
\end{itemize}

Uses a mix of recognition of column names and analysis of the column
contents to sort the columns. \texttt{NMorderColumns} does not sort
rows, nor does it modify any contents of columns.

\begin{itemize}
\item
  First: Standard columns (\texttt{ID}, \texttt{TIME}, \texttt{EVID}
  etc.) and usable columns first
\item
  Columns that cannot be converted to numeric are put in the back
\item
  Additional columns to place earlier (argument \texttt{first}) or late
  (\texttt{last}) can be specified.
\item
  See \texttt{?NMorderColumns} for more options.
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pk.old \textless{}{-}}\StringTok{ }\KeywordTok{copy}\NormalTok{(pk)}
\NormalTok{pk \textless{}{-}}\StringTok{ }\KeywordTok{NMorderColumns}\NormalTok{(pk,}\DataTypeTok{first=}\StringTok{"WEIGHTB"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: These standard nonmem columns were not found in
## data: MDV
\end{verbatim}

\normalsize

We may want to add \texttt{MDV} and rerun \texttt{NMorderColumns}.
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data.table}\NormalTok{(}\DataTypeTok{old=}\KeywordTok{colnames}\NormalTok{(pk.old),}\DataTypeTok{new=}\KeywordTok{colnames}\NormalTok{(pk))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          old      new
##  1:       ID      ROW
##  2:     TIME       ID
##  3:     EVID  NOMTIME
##  4:      CMT     TIME
##  5:      AMT     EVID
##  6:       DV      CMT
##  7:    STUDY      AMT
##  8:      BLQ       DV
##  9:    CYCLE  WEIGHTB
## 10:     DOSE     FLAG
## 11:  NOMTIME    STUDY
## 12:     PART      BLQ
## 13:  PROFDAY    CYCLE
## 14: PROFTIME     DOSE
## 15:  WEIGHTB     PART
## 16:     eff0  PROFDAY
## 17:   eventu PROFTIME
## 18:     name     eff0
## 19: timeunit   eventu
## 20:   trtact     flag
## 21:     FLAG     name
## 22:     flag timeunit
## 23:      ROW   trtact
##          old      new
\end{verbatim}
\end{column}

\normalsize
\end{columns}
\end{frame}

\begin{frame}[fragile]{NMwriteData}
\protect\hypertarget{nmwritedata}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
For the final step of writing the dataset, \texttt{NMwriteData} is
provided.

\begin{itemize}
\item
  Checks character variables for Nonmem compatibility (commas not
  allowed)
\item
  writes a csv file with appropriate options for Nonmem compatibility
\item
  Default is to also write an rds file for R
\item
  Contents identical to R object including all information (such as
  factor levels) which cannot be saved in csv.
\item
  If you use \texttt{NMscanData} to read Nonmem results, this
  information can be used automatically.
\item
  Provides a proposal for text to include in the \texttt{\$INPUT} and
  \texttt{\$DATA} sections of the Nonmem control streams.
\end{itemize}

\begin{block}{The csv writer is very simple}
\protect\hypertarget{the-csv-writer-is-very-simple}{}
These are the only steps involved between the supplied data set and the
written csv.

\begin{itemize}
\tightlist
\item
  \texttt{scipen} is small to maximize precision.
\end{itemize}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{file.csv \textless{}{-}}\StringTok{ }\KeywordTok{fnExtension}\NormalTok{(file,}\StringTok{".csv"}\NormalTok{)}
\KeywordTok{fwrite}\NormalTok{(data,}\DataTypeTok{na=}\StringTok{"."}\NormalTok{,}\DataTypeTok{quote=}\OtherTok{FALSE}\NormalTok{,}\DataTypeTok{row.names=}\OtherTok{FALSE}\NormalTok{,}\DataTypeTok{scipen=}\DecValTok{0}\NormalTok{,}\DataTypeTok{file=}\NormalTok{file.csv)}
\end{Highlighting}
\end{Shaded}

\normalsize

All arguments to \texttt{fwrite} can be modified using the
\texttt{args.fwrite} argument.
\end{block}
\end{column}

\begin{column}{0.48\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{NMwriteData}\NormalTok{(pk,}\DataTypeTok{file=}\StringTok{"derived/pk.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Data written to file(s):
## derived/pk.csv
## derived/pk.rds
\end{verbatim}

\begin{verbatim}
## For NonMem:
## $INPUT ROW ID NOMTIME TIME EVID CMT AMT DV WEIGHTB
## FLAG STUDY BLQ CYCLE DOSE PART PROFDAY PROFTIME eff0
## $DATA derived/pk.csv
## IGN=@
## IGNORE=(FLAG.NE.0)
\end{verbatim}

\normalsize

\vspace{12pt}

\begin{itemize}
\item
  \texttt{NMwriteData} \emph{Never} modifies the data.
\item
  \texttt{eff0} is the last column in \texttt{pk} that \texttt{Nonmem}
  can make use of (remember \texttt{NMisNumeric} from earlier?)
\item
  \texttt{NMwriteData} detected the exclusion flag and suggests to
  include it in \texttt{\$DATA}.
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Update Nonmem control streams}
\protect\hypertarget{update-nonmem-control-streams}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{itemize}
\item
  \texttt{NMwriteSection} is a function that replaces sections (like
  \$DATA or \$TABLE) of nonmem control streams.
\item
  \texttt{NMwriteData} returns a list that can be directly processed by
  \texttt{NMwriteSection}
\item
  In \texttt{NMwriteData}, several arguments modify the proposed text
  the proposed text for the Nonmem run, see \texttt{?NMwriteData}.
\end{itemize}

\begin{block}{Tips}
\protect\hypertarget{tips}{}
\begin{itemize}
\item
  \texttt{NMextractDataFile} takes a control stream/list file and
  extracts the input data file name/path. You can use this to identify
  the model runs in which to update \texttt{\$DATA}.
\item
  \texttt{NMwriteData} is very useful for many other sections, like
  \texttt{\$TABLE}, or even \texttt{\$PK}. But not \texttt{\$THETA} and
  \texttt{\$OMEAGE} (because they are specific to each model).
\item
  \texttt{NMwriteData} by defaults saves a backup of the overwritten
  control streams.
\item
  \texttt{NMwriteData} has a counterpart in \texttt{NMreadSection}
\end{itemize}
\end{block}
\end{column}

\begin{column}{0.48\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nmCode \textless{}{-}}\StringTok{ }\KeywordTok{NMwriteData}\NormalTok{(pk,}\DataTypeTok{file=}\StringTok{"derived/pk.csv"}\NormalTok{,}
                      \DataTypeTok{write.csv=}\OtherTok{FALSE}\NormalTok{,}
\CommentTok{\#\#\# arguments that tailors text for Nonmem}
                      \DataTypeTok{nmdir.data=}\StringTok{"../derived"}\NormalTok{,}
                      \DataTypeTok{nm.drop=}\StringTok{"PROFDAY"}\NormalTok{,}
                      \DataTypeTok{nm.rename=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{CONC=}\StringTok{"DV"}\NormalTok{),}
                      \CommentTok{\#\# PSN compatibility}
                      \DataTypeTok{nm.capitalize=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Data _not_ witten to any files.
\end{verbatim}

\begin{verbatim}
## For NonMem:
## $INPUT ROW ID NOMTIME TIME EVID CMT AMT CONC=DV
## WEIGHTB FLAG STUDY BLQ CYCLE DOSE PART PROFDAY=DROP
## PROFTIME EFF0
## $DATA ../derived/pk.csv
## IGN=@
## IGNORE=(FLAG.NE.0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\# example: pick run1*.mod}
\NormalTok{models \textless{}{-}}\StringTok{ }\KeywordTok{list.files}\NormalTok{(}\StringTok{"../models"}\NormalTok{,}\DataTypeTok{pattern=}\StringTok{"run1.+}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.mod$"}\NormalTok{,}
                     \DataTypeTok{full.names=}\NormalTok{T)}
\CommentTok{\#\# update $INPUT and $DATA}
\KeywordTok{lapply}\NormalTok{(models,NMwriteSection,}\DataTypeTok{list.sections=}\NormalTok{nmCode)}
\CommentTok{\#\# update $INPUT }
\KeywordTok{lapply}\NormalTok{(models,}
\NormalTok{       NMwriteSection,}\DataTypeTok{section=}\StringTok{"INPUT"}\NormalTok{,}\DataTypeTok{newlines=}\NormalTok{nmCode}\OperatorTok{$}\NormalTok{INPUT)}
\end{Highlighting}
\end{Shaded}

\normalsize
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Automated documentation of data}
\protect\hypertarget{automated-documentation-of-data}{}
\framesubtitle{Ensure that the data can be traced back to the data generation script}

\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{itemize}
\item
  If the argument \texttt{script} is supplied to \texttt{NMwriteData}, a
  little meta information is saved together with the output file(s).
\item
  For csv files, the meta data is written to a txt file next to the csv
  file.
\item
  For rds files, the meta data is attached to the object saved in the
  \texttt{rds} file.
\item
  \texttt{stampObj} is used under the hood. You can use
  \texttt{stampObj} on any R object to attach similar meta information.
\item
  Additional arguments (essentially anything) can be passed from
  \texttt{NMwriteData} to \texttt{stampObj} using the argument
  \texttt{args.stamp}.
\item
  \texttt{stampObj} and \texttt{objInfo} write and read an ``attribute''
  called \texttt{objInfo}.
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{NMwriteData}\NormalTok{(pk,}\DataTypeTok{file=}\StringTok{"derived/pk.csv"}\NormalTok{,}
            \DataTypeTok{script =} \StringTok{"NMdata\_Rpackage.Rmd"}\NormalTok{,}\DataTypeTok{quiet=}\NormalTok{T)}
\KeywordTok{list.files}\NormalTok{(}\StringTok{"derived"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "pk.csv"      "pk.rds"      "pk_meta.txt"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\# NMreadCsv reads the metadata .txt file if found}
\NormalTok{pknm \textless{}{-}}\StringTok{ }\KeywordTok{NMreadCsv}\NormalTok{(}\StringTok{"derived/pk.csv"}\NormalTok{)}
\KeywordTok{objInfo}\NormalTok{(pknm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $DataCreateScript
## [1] "NMdata_Rpackage.Rmd"
## 
## $CreationTime
## [1] "2021-06-07 22:52:47"
## 
## $writtenTo
## [1] "derived/pk.csv"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\# The .rds file contains the metadata already}
\NormalTok{pknm2 \textless{}{-}}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\StringTok{"derived/pk.rds"}\NormalTok{)}
\KeywordTok{objInfo}\NormalTok{(pknm2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $DataCreateScript
## [1] "NMdata_Rpackage.Rmd"
## 
## $CreationTime
## [1] "2021-06-07 22:52:47 EDT"
## 
## $writtenTo
## [1] "derived/pk.rds"
\end{verbatim}
\end{column}
\end{columns}

\normalsize
\end{frame}

\hypertarget{retrieving-data-from-nonmem-runs}{%
\section{Retrieving data from Nonmem
runs}\label{retrieving-data-from-nonmem-runs}}

\begin{frame}[fragile]{NMscanData}
\protect\hypertarget{nmscandata}{}
\texttt{NMscanData} is an automated and general reader of Nonmem. It
returns one data set combining all information from input data and all
output tables. Based on the list file (\texttt{.lst}) it will:

\begin{itemize}
\tightlist
\item
  Read and combine output tables
\item
  If wanted, read input data and restore variables that were not output
  from the \texttt{Nonmem} model
\item
  If wanted, also restore rows from input data that were disregarded in
  \texttt{Nonmem} (e.g.~observations or subjects that are not part of
  the analysis)
\item
  Perform multiple consistency checks
\end{itemize}

\pause
\footnotesize

\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{file1.lst \textless{}{-}}\StringTok{ }\KeywordTok{system.file}\NormalTok{(}\StringTok{"examples/nonmem/xgxr003.lst"}\NormalTok{,}
                         \DataTypeTok{package=}\StringTok{"NMdata"}\NormalTok{)}
\NormalTok{res0 \textless{}{-}}\StringTok{ }\KeywordTok{NMscanData}\NormalTok{(file1.lst,}\DataTypeTok{merge.by.row=}\OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Model:  xgxr003
\end{verbatim}

\begin{verbatim}
## Input and output data combined by translation of
## Nonmem data filters (not recommended).
\end{verbatim}

\begin{verbatim}
## 
## Used tables, contents shown as used/total:
##                  file     rows columns     IDs
##       xgxr003_res.txt  905/905     7/7 150/150
##  xgxr003_res_vols.txt  905/905     3/7 150/150
##    xgxr003_res_fo.txt  150/150     1/2 150/150
##     xgxr1.csv (input) 905/1502   21/24 150/150
## 
## Distribution of rows on event types in returned data:
##  EVID Output
##     0    755
##     1    150
\end{verbatim}
\end{column}

\pause

\begin{column}{0.48\textwidth}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{class}\NormalTok{(res0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "NMdata"     "data.table" "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dims}\NormalTok{(res0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    data nrows ncols
## 1: res0   905    34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{head}\NormalTok{(res0,}\DataTypeTok{n=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ROW ID NOMTIME TIME EVID CMT AMT DV FLAG STUDY     KA
## 1:   1 31       0    0    1   1   3  0    0     1 0.1812
## 2:  11 32       0    0    1   1   3  0    0     1 0.1812
##          Q PRED RES WRES    V2     V3 BLQ CYCLE DOSE PART
## 1: 2307400    0   0    0 0.042 0.1785   0     1    3    1
## 2: 2307400    0   0    0 0.042 0.1785   0     1    3    1
##    PROFDAY PROFTIME WEIGHTB   EFF0        CL EVENTU   NAME
## 1:       1        0  87.031 56.461 0.7245691     mg Dosing
## 2:       1        0 100.620 45.096 0.7245691     mg Dosing
##    TIMEUNIT TRTACT   flag trtact   model nmout
## 1:    Hours   3 mg Dosing   3 mg xgxr003  TRUE
## 2:    Hours   3 mg Dosing   3 mg xgxr003  TRUE
\end{verbatim}

\normalsize
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Remember the unique row identifier}
\protect\hypertarget{remember-the-unique-row-identifier}{}
Using a unique row identifier for merging data is highly recommended:

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{file1.lst \textless{}{-}}\StringTok{ }\KeywordTok{system.file}\NormalTok{(}\StringTok{"examples/nonmem/xgxr001.lst"}\NormalTok{, }\DataTypeTok{package=}\StringTok{"NMdata"}\NormalTok{)}
\NormalTok{res1 \textless{}{-}}\StringTok{ }\KeywordTok{NMscanData}\NormalTok{(file1.lst,}\DataTypeTok{merge.by.row=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Model:  xgxr001 
## Input and output data merged by: ROW 
## 
## Used tables, contents shown as used/total:
##               file     rows columns     IDs
##    xgxr001_res.txt  905/905   16/16 150/150
##  xgxr1.csv (input) 905/1502   22/24 150/150
## 
## Distribution of rows on event types in returned data:
##  EVID Output
##     0    755
##     1    150
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{class}\NormalTok{(res0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "NMdata"     "data.table" "data.frame"
\end{verbatim}

\normalsize
\end{frame}

\begin{frame}[fragile]{NMscanData}
\protect\hypertarget{nmscandata-1}{}
\framesubtitle{Example: quickly get from a list file to looking at the model}

\footnotesize

\begin{columns}[T]
\begin{column}{0.45\textwidth}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\# Using data.table for easy summarize}
\NormalTok{res1 \textless{}{-}}\StringTok{ }\KeywordTok{NMscanData}\NormalTok{(file1.lst,}\DataTypeTok{merge.by.row=}\OtherTok{TRUE}\NormalTok{,}
                   \DataTypeTok{as.fun=}\StringTok{"data.table"}\NormalTok{,}\DataTypeTok{quiet=}\OtherTok{TRUE}\NormalTok{)}
\CommentTok{\#\# Derive geometric mean pop predictions by}
\CommentTok{\#\# treatment and nominal sample time. Only}
\CommentTok{\#\# use sample records.}
\NormalTok{res1.mean \textless{}{-}}
\StringTok{    }\NormalTok{res1[EVID}\OperatorTok{==}\DecValTok{0}\NormalTok{,}
\NormalTok{         .(}\DataTypeTok{gmPRED=}\KeywordTok{exp}\NormalTok{(}\KeywordTok{mean}\NormalTok{(}\KeywordTok{log}\NormalTok{(PRED)))),}
\NormalTok{         by=.(trtact,NOMTIME)]}
\CommentTok{\#\# plot individual observations and geometric}
\CommentTok{\#\# mean pop predictions. Split (facet) by treatment.}
\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{subset}\NormalTok{(res1,EVID}\OperatorTok{==}\DecValTok{0}\NormalTok{))}\OperatorTok{+}
\StringTok{    }\KeywordTok{geom\_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(TIME,DV))}\OperatorTok{+}
\StringTok{    }\KeywordTok{geom\_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(NOMTIME,gmPRED),}
              \DataTypeTok{data=}\NormalTok{res1.mean,}\DataTypeTok{colour=}\StringTok{"red"}\NormalTok{)}\OperatorTok{+}
\StringTok{    }\KeywordTok{scale\_y\_log10}\NormalTok{()}\OperatorTok{+}
\StringTok{    }\KeywordTok{facet\_wrap}\NormalTok{(}\OperatorTok{\textasciitilde{}}\NormalTok{trtact,}\DataTypeTok{scales=}\StringTok{"free\_y"}\NormalTok{,}\DataTypeTok{ncol=}\DecValTok{2}\NormalTok{)}\OperatorTok{+}
\StringTok{    }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x=}\StringTok{"Hours since administration"}\NormalTok{,}
         \DataTypeTok{y=}\StringTok{"Concentration (ng/mL)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\end{column}

\begin{column}{0.55\textwidth}
\normalsize

\begin{center}\includegraphics[width=1.05\linewidth]{plots/aplot-1} \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Recover discarded rows}
\protect\hypertarget{recover-discarded-rows}{}
\begin{columns}[T]
\begin{column}{0.45\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res2 \textless{}{-}}\StringTok{ }\KeywordTok{NMscanData}\NormalTok{(file1.lst,}
                   \DataTypeTok{merge.by.row=}\OtherTok{TRUE}\NormalTok{,}\DataTypeTok{recover.rows=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Model:  xgxr001 
## Input and output data merged by: ROW 
## 
## Used tables, contents shown as used/total:
##               file      rows columns     IDs
##    xgxr001_res.txt   905/905   16/16 150/150
##  xgxr1.csv (input) 1502/1502   22/24 150/150
## 
## Distribution of rows on event types in returned data:
##  EVID Input only Output
##     0        597    755
##     1          0    150
\end{verbatim}

\begin{itemize}
\tightlist
\item
  No information is carried from output tables to recovered input data
  rows. For instance, it could make sense to merge back unique values
  within subjects (like subject level parameter estimates). Such
  ``back-filling'' must be done manually (easy with \texttt{data.table}
  or \texttt{dplyr}).
\end{itemize}
\end{column}

\begin{column}{0.55\textwidth}
\begin{center}\includegraphics[width=1.05\linewidth]{plots/unnamed-chunk-29-1} \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Compare models}
\protect\hypertarget{compare-models}{}
\framesubtitle{Example: Renaming and combining models by `rbind`}

\begin{columns}[T]
\begin{column}{0.45\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{NMdataConf}\NormalTok{(}\DataTypeTok{as.fun=}\StringTok{"data.table"}\NormalTok{)}
\KeywordTok{NMdataConf}\NormalTok{(}\DataTypeTok{col.row=}\StringTok{"ROW"}\NormalTok{)}
\KeywordTok{NMdataConf}\NormalTok{(}\DataTypeTok{merge.by.row=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\# notice fill is an option to rbind with data.table}
\NormalTok{lst}\FloatTok{.1}\NormalTok{ \textless{}{-}}\StringTok{ }\KeywordTok{system.file}\NormalTok{(}\StringTok{"examples/nonmem/xgxr001.lst"}\NormalTok{,}
                     \DataTypeTok{package=}\StringTok{"NMdata"}\NormalTok{)}
\NormalTok{lst}\FloatTok{.2}\NormalTok{ \textless{}{-}}\StringTok{ }\KeywordTok{system.file}\NormalTok{(}\StringTok{"examples/nonmem/xgxr014.lst"}\NormalTok{,}
                     \DataTypeTok{package=}\StringTok{"NMdata"}\NormalTok{)}
\NormalTok{res1.m \textless{}{-}}\StringTok{ }\KeywordTok{NMscanData}\NormalTok{(lst}\FloatTok{.1}\NormalTok{,}\DataTypeTok{quiet=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{res2.m \textless{}{-}}\StringTok{ }\KeywordTok{NMscanData}\NormalTok{(lst}\FloatTok{.2}\NormalTok{,}\DataTypeTok{quiet=}\OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{modelname=}\StringTok{"single{-}compartment"}\NormalTok{)}

\NormalTok{res.mult \textless{}{-}}\StringTok{ }\KeywordTok{rbind}\NormalTok{(res1.m,res2.m,}\DataTypeTok{fill=}\NormalTok{T)}
\NormalTok{res.mult.mean \textless{}{-}}\StringTok{ }\NormalTok{res.mult[EVID}\OperatorTok{==}\DecValTok{0}\OperatorTok{\&}\NormalTok{nmout}\OperatorTok{==}\OtherTok{TRUE}\NormalTok{,}
\NormalTok{                          .(}\DataTypeTok{gmPRED=}\KeywordTok{exp}\NormalTok{(}\KeywordTok{mean}\NormalTok{(}\KeywordTok{log}\NormalTok{(PRED)))),}
\NormalTok{                          by=.(model,trtact,NOMTIME)]}

\KeywordTok{ggplot}\NormalTok{(res.mult.mean,}\KeywordTok{aes}\NormalTok{(NOMTIME,gmPRED,}\DataTypeTok{colour=}\NormalTok{model))}\OperatorTok{+}
\StringTok{    }\KeywordTok{geom\_line}\NormalTok{()}\OperatorTok{+}
\StringTok{    }\KeywordTok{scale\_y\_log10}\NormalTok{()}\OperatorTok{+}
\StringTok{    }\KeywordTok{geom\_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(TIME,DV),}\DataTypeTok{data=}\NormalTok{res1.m,}
               \DataTypeTok{alpha=}\NormalTok{.}\DecValTok{5}\NormalTok{,}\DataTypeTok{colour=}\StringTok{"grey"}\NormalTok{)}\OperatorTok{+}
\StringTok{    }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x=}\StringTok{"Hours since administration"}\NormalTok{,}\DataTypeTok{y=}\StringTok{"Concentration (ng/mL)"}\NormalTok{)}\OperatorTok{+}
\StringTok{    }\KeywordTok{facet\_wrap}\NormalTok{(}\OperatorTok{\textasciitilde{}}\NormalTok{trtact,}\DataTypeTok{scales=}\StringTok{"free\_y"}\NormalTok{,}\DataTypeTok{ncol=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\end{column}

\begin{column}{0.55\textwidth}
\normalsize

\begin{center}\includegraphics[width=1.05\linewidth]{plots/compmodels-1} \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Preserve all input data properties}
\protect\hypertarget{preserve-all-input-data-properties}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
By default, \texttt{NMscanData} will look for an rds file next to the
csv file (same file name, only extension .rds different).

\begin{itemize}
\item
  If this is found, it will be read, providing an enriched
  (e.g.~conserving factor levels and any other information).
\item
  There are no checks of consistency of \texttt{rds} file against
  delimited file read by \texttt{Nonmem}.
\item
  I am interested in ideas on how to do this. If we can avoid reading
  the csv file, it would be highly prefered.
\item
  You get the rds automatically if using \texttt{NMwriteData}.
\item
  Disable looking for the rds by argument \texttt{use.rds=FALSE}.
\item
  Default value of \texttt{use.rds} can be modified with
  \texttt{NMdataConf}.
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
Notice, the plots are correctly ordered by doses - because they are
ordered by factor levels.

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lst \textless{}{-}}\StringTok{ }\KeywordTok{system.file}\NormalTok{(}\StringTok{"examples/nonmem/xgxr014.lst"}\NormalTok{,}
                   \DataTypeTok{package=}\StringTok{"NMdata"}\NormalTok{)}
\NormalTok{res14 \textless{}{-}}\StringTok{ }\KeywordTok{NMscanData}\NormalTok{(lst,}\DataTypeTok{quiet=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1.05\linewidth]{plots/unnamed-chunk-32-1} \end{center}
\end{column}
\end{columns}

\normalsize
\end{frame}

\begin{frame}[fragile]{The NMdata class}
\protect\hypertarget{the-nmdata-class}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
Most important message: an \texttt{NMdata} object can be used as if it
weren't. \texttt{R} looks sequentially for ``methods'' matching the
classes of an object.

Methods defined for \texttt{NMdata}:

\begin{itemize}
\tightlist
\item
  \texttt{summary}: The information that is written to the console if
  \texttt{quiet=FALSE}.
\end{itemize}

This is the only behavior that is overwritten by the \texttt{NMdata}
class.

Simple other methods like \texttt{rbind} and similar are defined by
dropping the \texttt{NMdata} class and then perform the operation.

\begin{itemize}
\tightlist
\item
  \texttt{NMinfo} lists metadata from \texttt{NMdata} objects and only
  works on \texttt{NMdata} objects.
\item
  \texttt{NMinfo(res1,"details")}: How was the data read and combined?
\item
  \texttt{NMinfo(res1,"tables")}: What tables were read and how?
\item
  \texttt{NMinfo(res1,"columns")}: What columns were read from what
  tables?
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{class}\NormalTok{(res1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "NMdata"     "data.table" "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{NMinfo}\NormalTok{(res1,}\StringTok{"details"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $call
## [1] "NMscanData(file1.lst, merge.by.row = TRUE, as.fun = \"data.table\", "
## [2] "    quiet = TRUE)"                                                   
## 
## $time.call
## [1] "2021-06-07 22:52:48 EDT"
## 
## $model
## [1] "xgxr001"
## 
## $file.lst
## [1] "C:/Users/delff/working_copies/NMdata/inst/examples/nonmem/xgxr001.lst"
## 
## $mtime.lst
## [1] "2021-05-14 15:27:25 EDT"
## 
## $input.used
## [1] TRUE
## 
## $rows.recovered
## [1] FALSE
## 
## $merge.by.row
## [1] TRUE
## 
## $col.row
## [1] "ROW"
## 
## $file.input
## [1] "C:/Users/delff/working_copies/NMdata/inst/examples/data/xgxr1.csv"
## 
## $mtime.input
## [1] "2021-04-05 21:17:54 EDT"
\end{verbatim}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{The NMdata class}
\protect\hypertarget{the-nmdata-class-1}{}
\framesubtitle{What data was read?}

\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{block}{Table-specific information}
\protect\hypertarget{table-specific-information}{}
\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{NMinfo}\NormalTok{(res1,}\StringTok{"tables"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    source            name nrow ncol
## 1: output xgxr001_res.txt  905   16
## 2:  input       xgxr1.csv 1502   24
##                                                                         file
## 1: C:/Users/delff/working_copies/NMdata/inst/examples/nonmem/xgxr001_res.txt
## 2:         C:/Users/delff/working_copies/NMdata/inst/examples/data/xgxr1.csv
##    firstonly lastonly firstlastonly format  sep idlevel
## 1:     FALSE    FALSE         FALSE               FALSE
## 2:        NA       NA            NA   <NA> <NA>      NA
##             file.mtime has.row maxLength full.length
## 1: 2021-04-05 21:38:48    TRUE      TRUE        TRUE
## 2: 2021-04-05 21:17:54      NA        NA          NA
##    filetype nid
## 1:     <NA>  NA
## 2:     text 150
\end{verbatim}
\end{block}
\end{column}

\begin{column}{0.48\textwidth}
\begin{block}{Column-specific information}
\protect\hypertarget{column-specific-information}{}
(The \texttt{nrows} and \texttt{topn} arguments are arguments to
\texttt{print.data.table} to get a top and bottom snip of the table.)
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{print}\NormalTok{(}\KeywordTok{NMinfo}\NormalTok{(res1,}\StringTok{"columns"}\NormalTok{),}\DataTypeTok{nrows=}\DecValTok{20}\NormalTok{,}\DataTypeTok{topn=}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     variable            file     source level COLNUM
##  1:      ROW xgxr001_res.txt     output   row      1
##  2:       ID       xgxr1.csv      input   row      2
##  3:  NOMTIME       xgxr1.csv      input   row      3
##  4:     TIME       xgxr1.csv      input   row      4
##  5:     EVID       xgxr1.csv      input   row      5
##  6:      CMT       xgxr1.csv      input   row      6
##  7:      AMT       xgxr1.csv      input   row      7
##  8:       DV xgxr001_res.txt     output   row      8
##  9:     FLAG       xgxr1.csv      input   row      9
## 10:    STUDY       xgxr1.csv      input   row     10
## ---                                                 
## 33:   EVENTU       xgxr1.csv      input   row     33
## 34:     NAME       xgxr1.csv      input   row     34
## 35: TIMEUNIT       xgxr1.csv      input   row     35
## 36:   TRTACT       xgxr1.csv      input   row     36
## 37:     flag       xgxr1.csv      input   row     37
## 38:   trtact       xgxr1.csv      input   row     38
## 39:    model            <NA> NMscanData model     39
## 40:    nmout            <NA> NMscanData   row     40
## 41:      ROW       xgxr1.csv      input   row     NA
## 42:       DV       xgxr1.csv      input   row     NA
\end{verbatim}
\end{block}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{What should I do for my models to be compatible
with NMscanData?}
\protect\hypertarget{what-should-i-do-for-my-models-to-be-compatible-with-nmscandata}{}
\begin{itemize}
\item
  The answer to this should be as close to ``nothing'' as possible -
  that's more or less the aim of the function.
\item
  (As always) you just have to make sure that the information that you
  need is present in input data and output data.
\item
  No need to output information that is unchanged from input, but make
  sure to output what you need (like \texttt{IPRED}, \texttt{CWRES},
  \texttt{CL}, \texttt{ETA1} etc which cannot be found in input). Always
  output the row identifier!
\item
  Some of these values can be found from other files generated by
  \texttt{Nonmem} but notice: \texttt{NMscanData} uses only input and
  output data.
\item
  Including a unique row identifier in both input and output data is the
  most robust way to combine the tables.
\item
  In \texttt{firstonly} tables, include the subject ID or the row
  identifier.
\item
  Everything will most likely work even if you don't
\item
  I would not take ``most likely'' when robustness is available.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{\texttt{NMscanData} limitations}
\protect\hypertarget{nmscandata-limitations}{}
The most important limitation to have in mind is not related to
\texttt{NMscanData} iteself

\begin{itemize}
\tightlist
\item
  If merging with input data, the input data must be available as was
  when the model was run.
\item
  Option 1: ``Freeze'' model runs together with data.
  \texttt{NMfreezeModels} does that and will be included in
  \texttt{NMdata} after a little more testing.
\item
  Option 2 (platform-dependent): \texttt{Nonmem} can be run in a wrapper
  script that either copies the input data, or runs \texttt{NMscanData}
  and saves the output in a compressed file format (like \texttt{rds}).
\end{itemize}

Even if limitations of \texttt{NMscanData} may be several, they are all
rare. There is a very good chance you will never run into any of them.

\begin{itemize}
\item
  Not all data filter statements implemented. Nested \texttt{ACCEPT} and
  \texttt{IGNORE} statements are not supported at this point. The
  resulting number of rows after applying filters is checked against
  row-level output table dimensions (if any available). It is always
  recommended to use a unique row identifier in both input and output
  tables in order to avoid relying on interpretation of \texttt{Nonmem}
  code.
\item
  The \texttt{RECORDS} and \texttt{NULL} options in \texttt{\$DATA} are
  not implemented. If using \texttt{RECORDS}, please use the
  \texttt{col.row} option to merge by a unique row identifier.
\item
  Character time variables not interpreted. If you need this, we can
  implement it relatively easily.
\item
  Only output tables returning either all rows or one row per subject
  can be merged with input. Tables written with options like
  \texttt{FIRSTLASTONLY} (two rows per subject) and \texttt{OBSONLY} are
  disregarded with a warning (you can read them with
  \texttt{NMscanTables}). \texttt{LASTONLY} is treated like
  \texttt{FIRSTONLY}, i.e.~as ID-level information if not available
  elsewhere.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Data read building blocks}
\protect\hypertarget{data-read-building-blocks}{}
\texttt{NMscanData} uses a few simpler functions to read all the data it
can find. These functions may be useful when you don't want the full
automatic package provided by \texttt{NMscanData}.

\begin{itemize}
\tightlist
\item
  \texttt{NMreadTab}
\item
  Fast read and format output tables from Nonmem.
\item
  Handles the ``\texttt{TABLE\ NO.}'' counter
\item
  \texttt{NMscanTables} (uses \texttt{NMreadTab})
\item
  Given a control stream or list file, read all output tables
\item
  \texttt{NMreadCsv}
\item
  Fast read delimited (input data) files
\item
  \texttt{NMscanInput} (uses \texttt{NMreadCSV})
\item
  Given a control stream or list file, read input data.
\item
  Optionally reads and applies Nonmem ignore/accept statements
\item
  Optionally translates column names according to names used in Nonmem
\end{itemize}
\end{frame}

\hypertarget{configuration-of-nmdata-defaults}{%
\section{Configuration of NMdata
defaults}\label{configuration-of-nmdata-defaults}}

\begin{frame}[fragile]{NMdataConf}
\protect\hypertarget{nmdataconf}{}
\framesubtitle{Tailor `NMdata` default behavior to your setup and preferences}

\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{itemize}
\item
  \texttt{NMdataConf} supports changing many default argument values,
  simplifying coding.
\item
  Notice, values are reset when \texttt{library(NMdata)} or
  \texttt{NMdataConf(reset=TRUE)} are called.
\item
  See all currently used values by \texttt{NMdataConf()}.
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
My initialization of scripts often contain this:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(NMdata)}
\KeywordTok{NMdataConf}\NormalTok{(}\DataTypeTok{as.fun=}\StringTok{"data.table"}
\CommentTok{\#\#\# this is the default value}
\NormalTok{          ,}\DataTypeTok{col.row=}\StringTok{"ROW"}
\CommentTok{\#\#\# Recommended but \_right now\_ not default}
\NormalTok{          ,}\DataTypeTok{merge.by.row=}\OtherTok{TRUE}
\CommentTok{\#\#\# You can switch this when script is final}
\NormalTok{          ,}\DataTypeTok{quiet=}\OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\end{column}
\end{columns}

Other commonly used settings in \texttt{NMdataConf} are

\begin{itemize}
\tightlist
\item
  \texttt{as.fun}: a function to apply to all objects before returning
  them from \texttt{NMdata} functions. If you use
  \texttt{dplyr/tidyverse}, do (notice, no quotes!):
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tibble)}
\KeywordTok{NMdataConf}\NormalTok{(}\DataTypeTok{as.fun=}\NormalTok{tibble}\OperatorTok{::}\NormalTok{as\_tibble)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\item
  \texttt{recover.rows}: Should \texttt{NMscanData} Include rows not
  processed by Nonmem? (default \texttt{FALSE}).
\item
  \texttt{use.input}: Should \texttt{NMscanData} combine (output data)
  with input data? (default \texttt{TRUE})
\item
  \texttt{file.mod}: A function that translates the list file path to
  the input control stream file path. Default is to replace extension
  with \texttt{.mod}.
\item
  \texttt{check.time}: Default is \texttt{TRUE}, meaning that output
  (list file and tables) are expected to newer than input (control
  stream and input data). If say you copy files between systems, this
  check may not make sense.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Why does \texttt{NMdata} not use
\texttt{options()}?}
\protect\hypertarget{why-does-nmdata-not-use-options}{}
\texttt{R} has a system for handling settings. \texttt{NMdata} does not
use that.

\begin{itemize}
\tightlist
\item
  Main reason: \texttt{NMdataConf} can check both setting/argument names
  and values for consistency.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{try}\NormalTok{(}\KeywordTok{NMdataConf}\NormalTok{(}\DataTypeTok{asfun=}\NormalTok{tibble}\OperatorTok{::}\NormalTok{as\_tibble))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in NMdataConfOptions(name) : Option not found
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{try}\NormalTok{(}\KeywordTok{NMdataConf}\NormalTok{(}\DataTypeTok{use.input=}\StringTok{"FALSE"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in NMdataDecideOption(names.args[I], val) : 
##   use.input must be logical
\end{verbatim}

\begin{itemize}
\tightlist
\item
  A few extra features are available with \texttt{NMdataConf}:
\item
  Reset all settings: \texttt{NMdataConf(reset=TRUE)}
\item
  Reset individual settings:
  \texttt{NMdataConf(use.input=NULL,\ as.fun=NULL)}
\item
  Retrieve all current settings: \texttt{NMdataConf()}
\end{itemize}
\end{frame}

\hypertarget{next-steps-for-nmdata}{%
\section{\texorpdfstring{Next steps for
\texttt{NMdata}}{Next steps for NMdata}}\label{next-steps-for-nmdata}}

\begin{frame}[fragile]{How is \texttt{NMdata} qualified?}
\protect\hypertarget{how-is-nmdata-qualified}{}
\begin{itemize}
\item
  \texttt{NMdata} contains very little calculations (only exception may
  be \texttt{flagsAssign}/\texttt{flagsCount})
\item
  Historic bugs have mostly resulted in uninformative errors due to
  e.g.~failure in processing text
\item
  \texttt{NMdata} includes \textgreater60 ``unit tests'' where results
  of function calls with different datasets and arguments are compared
  to expected results
\item
  Tests are consistently run before any release of the package
\item
  The tests are crucial in making sure that fixing one bug or
  introducing a new feature does not introduce new bugs
\item
  If you have a specific example you want to make sure is tested in the
  package, we will include the test in the package
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Next steps for \texttt{NMdata}}
\protect\hypertarget{next-steps-for-nmdata-1}{}
\begin{itemize}
\tightlist
\item
  The next milestone is submitting the package to CRAN

  \begin{itemize}
  \tightlist
  \item
    Aiming for end of June
  \end{itemize}
\item
  Abstract submitted to ACoP
\item
  The following would be great help in making \texttt{NMdata} more
  accessible and useful

  \begin{itemize}
  \tightlist
  \item
    Testing - please use the package and provide feedback
  \item
    Review of documentation, vignettes, and descriptions/explanations on
    website
  \item
    Graphical representations and illustrations. A hexagon is needed!
  \item
    A tidyverse workflow for a new vignette
  \item
    If you have ideas you want to contribute, let's discuss!
  \end{itemize}
\item
  Before or after first version on CRAN

  \begin{itemize}
  \tightlist
  \item
    \texttt{NMcheckData}: Check data syntax/format compatibility with
    Nonmem
  \item
    \texttt{NMfreezeModels}: Save Nonmem models with input data and all
    results to ensure reproducibility of output
  \item
    Function for comparison of \texttt{\$DATA} and input data
  \end{itemize}
\item
  After first version on CRAN

  \begin{itemize}
  \tightlist
  \item
    Functions for easy documentation of column contents (description,
    units, 1:1 relationships between character and numeric columns)
  \end{itemize}
\end{itemize}
\end{frame}

\hypertarget{summary}{%
\section{Summary}\label{summary}}

\begin{frame}[fragile]{Summary}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
Data creation

\begin{itemize}
\tightlist
\item
  \texttt{renameByContents} -
\item
  \texttt{compareCols}
\item
  \texttt{mergeCheck}
\item
  \texttt{flagsAssign}/\texttt{flagsCount}
\item
  \texttt{NMorderColumns}
\item
  (\texttt{NMcheckData})
\item
  \texttt{NMwriteData}
\item
  \texttt{stampObj}/\texttt{objInfo}
\end{itemize}

Read/write Nonmem control streams

\begin{itemize}
\tightlist
\item
  \texttt{NMreadSection}/\texttt{NMwriteSection}
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
Retrieve data from Nonmem runs

\begin{itemize}
\tightlist
\item
  \texttt{NMscanData}
\item
  \texttt{NMinfo}
\item
  \texttt{NMscanInput}, \texttt{NMreadCsv}
\item
  \texttt{NMscanTables}, \texttt{NMreadTab}
\end{itemize}

Adjust behavior to your preferences

\begin{itemize}
\tightlist
\item
  \texttt{NMdataConf}
\end{itemize}

Other

\begin{itemize}
\tightlist
\item
  (\texttt{NMfreezeModels})
\end{itemize}
\end{column}
\end{columns}

\begin{block}{The plan is submission to CRAN this month!}
\protect\hypertarget{the-plan-is-submission-to-cran-this-month}{}
\end{block}
\end{frame}

\hypertarget{other-tools}{%
\section{Other tools}\label{other-tools}}

\begin{frame}[fragile]{pmxtricks}
\protect\hypertarget{pmxtricks}{}
A more diverse package

\begin{itemize}
\tightlist
\item
  \texttt{ggIndProfs}: Individual plots, including indication of doses
\item
  \texttt{ggwrite}: Saves images in sizes made for powerpoint, including
  stamps (time, source, output filename). It can save multiple plots at
  once as one file (pdf) or multiple files.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(remotes)}
\KeywordTok{install\_github}\NormalTok{(}\StringTok{"philipdelff/pmxtricks"}\NormalTok{,}\DataTypeTok{upgrade=}\StringTok{"never"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(pmxtricks)}
\end{Highlighting}
\end{Shaded}
\end{frame}

\begin{frame}[fragile]{Individual profiles including observations,
doses, and model predictions}
\protect\hypertarget{individual-profiles-including-observations-doses-and-model-predictions}{}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pls1 \textless{}{-}}\StringTok{ }\KeywordTok{ggIndProfs}\NormalTok{(res1,}\DataTypeTok{amt=}\StringTok{"AMT"}\NormalTok{,}\DataTypeTok{grp=}\StringTok{"trtact"}\NormalTok{,}\DataTypeTok{NPerSheet=}\DecValTok{36}\NormalTok{,}\DataTypeTok{labels=}\StringTok{"top{-}right"}\NormalTok{,}
                   \DataTypeTok{ylab=}\StringTok{"Concentration"}\NormalTok{,}\DataTypeTok{ylab2=}\StringTok{"Dose"}\NormalTok{)}
\KeywordTok{ggwrite}\NormalTok{(pls1[[}\DecValTok{5}\NormalTok{]],}\DataTypeTok{canvas=}\StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[height=0.75\textheight]{plots/unnamed-chunk-41-1} \end{center}
\normalsize
\end{frame}

\begin{frame}[fragile]{\texttt{ggwrite}: Flexible saving of tracable
output}
\protect\hypertarget{ggwrite-flexible-saving-of-tracable-output}{}
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\texttt{ggwrite} is a wrapper of \texttt{png} and \texttt{pdf} (and
\texttt{dev.off}) with convenience features such as

\begin{itemize}
\tightlist
\item
  Support for multiple plots at once

  \begin{itemize}
  \tightlist
  \item
    saved as either multiple files, named by list element names if
    wanted (or just numbered)
  \item
    or a single pdf with one plot per page
  \end{itemize}
\item
  Stamping with creation time, script name, and output name
\item
  ``canvas'' sizes made for powerpoint or full-screen display (see
  \texttt{?canvasSize})
\item
  Custom canvases are very simple to create
\item
  Independent \texttt{save} and \texttt{show} arguments for very simple
  conditional behavior

  \begin{itemize}
  \tightlist
  \item
    \texttt{save} defaults to \texttt{TRUE} if a filename is given
  \item
    \texttt{show} defaults to the inverse of \texttt{save}
  \end{itemize}
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
Save pls1, as one file and as multiple files, named by the dose levels.
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{writeOutput \textless{}{-}}\StringTok{ }\OtherTok{TRUE}
\NormalTok{script \textless{}{-}}\StringTok{ "path/to/script.R"}
\KeywordTok{ggwrite}\NormalTok{(pls1,}\DataTypeTok{file=}\StringTok{"results/individual\_profiles.png"}\NormalTok{,}
        \DataTypeTok{stamp=}\NormalTok{script,}\DataTypeTok{canvas=}\StringTok{"wide{-}screen"}\NormalTok{,}\DataTypeTok{useNames=}\OtherTok{TRUE}\NormalTok{,}
        \DataTypeTok{save=}\NormalTok{writeOutput)}
\KeywordTok{ggwrite}\NormalTok{(pls1,}\DataTypeTok{file=}\StringTok{"results/individual\_profiles.pdf"}\NormalTok{,}
        \DataTypeTok{stamp=}\NormalTok{script,}\DataTypeTok{canvas=}\StringTok{"wide{-}screen"}\NormalTok{,}\DataTypeTok{useNames=}\OtherTok{TRUE}\NormalTok{,}
        \DataTypeTok{save=}\NormalTok{writeOutput,}\DataTypeTok{onefile=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{list.files}\NormalTok{(}\StringTok{"results"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "individual_profiles.pdf"            
## [2] "individual_profiles_trtact100mg.png"
## [3] "individual_profiles_trtact10mg.png" 
## [4] "individual_profiles_trtact300mg.png"
## [5] "individual_profiles_trtact30mg.png" 
## [6] "individual_profiles_trtact3mg.png"
\end{verbatim}
\end{column}
\end{columns}

\begin{itemize}
\tightlist
\item
  Showing a bottom-right snip of
  \texttt{results/individual\_profiles\_trtact300mg.png}:
\end{itemize}

\begin{center}
\adjustbox{trim={.5\width} {0\height} {0\width} {.7\height},clip}{
    \includegraphics[width=\textwidth]{results/individual_profiles_trtact300mg.png}
}
\end{center}
\end{frame}

\begin{frame}[fragile]{\texttt{NMcheckData}: Check data syntax for
Nonmem compatibility}
\protect\hypertarget{nmcheckdata-check-data-syntax-for-nonmem-compatibility}{}
Aim: check data for all potential Nonmem compatibility issues and other
obvious errors. \includegraphics[width=0.5in]{figures/worksign.png}

\begin{columns}[T]
\begin{column}{0.48\textwidth}
\begin{itemize}
\tightlist
\item
  Currently checks for:

  \begin{itemize}
  \tightlist
  \item
    Presence, no NA, and compatibility of \texttt{TIME}, \texttt{EVID},
    \texttt{ID}, \texttt{CMT}
  \item
    DV must be NA at dosing events
  \item
    If available MDV and col.flagn must be numeric and non-missing
  \item
    EVID one of 0,1,2,3,4
  \item
    ID's are disjoint
  \item
    TIME increasing within constant ID
  \end{itemize}
\item
  Todo

  \begin{itemize}
  \tightlist
  \item
    Many checks will be added and most of them are simple to implement
  \item
    Has to accept many more alternative ways to code the data
  \end{itemize}
\item
  It is experimental but safe

  \begin{itemize}
  \tightlist
  \item
    `NMcheckData is a ``look but don't touch'' function, so worst case
    is output is confusing.
  \item
    You could get a strange error due to ``holes'' in the function that
    haven't yet been implemented.
  \end{itemize}
\end{itemize}
\end{column}

\begin{column}{0.48\textwidth}
\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res.check \textless{}{-}}\StringTok{ }\KeywordTok{NMcheckData}\NormalTok{(pk)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  column                      check    N
##     MDV           Column not found    1
##     CMT CMT not a positive integer 1502
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res.check}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                            check column  row
##    1:           Column not found    MDV   NA
##    2: CMT not a positive integer    CMT    1
##    3: CMT not a positive integer    CMT    2
##    4: CMT not a positive integer    CMT    3
##    5: CMT not a positive integer    CMT    4
##   ---                                       
## 1499: CMT not a positive integer    CMT 1498
## 1500: CMT not a positive integer    CMT 1499
## 1501: CMT not a positive integer    CMT 1500
## 1502: CMT not a positive integer    CMT 1501
## 1503: CMT not a positive integer    CMT 1502
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pkmod \textless{}{-}}\StringTok{ }\KeywordTok{copy}\NormalTok{(pk)}
\NormalTok{pkmod[,MDV}\OperatorTok{:}\ErrorTok{=}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(DV))]}
\NormalTok{pkmod[ID}\OperatorTok{==}\DecValTok{33}\OperatorTok{\&}\NormalTok{EVID}\OperatorTok{==}\DecValTok{1}\NormalTok{,CMT}\OperatorTok{:}\ErrorTok{=}\OtherTok{NA}\NormalTok{]}
\NormalTok{res.check \textless{}{-}}\StringTok{ }\KeywordTok{NMcheckData}\NormalTok{(pkmod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  column                      check    N
##     CMT                      is NA    1
##     CMT CMT not a positive integer 1501
##     MDV   DV not NA in dosing recs  150
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res.check}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                            check column  row
##    1:                      is NA    CMT   21
##    2: CMT not a positive integer    CMT    1
##    3: CMT not a positive integer    CMT    2
##    4: CMT not a positive integer    CMT    3
##    5: CMT not a positive integer    CMT    4
##   ---                                       
## 1648:   DV not NA in dosing recs    MDV 1453
## 1649:   DV not NA in dosing recs    MDV 1463
## 1650:   DV not NA in dosing recs    MDV 1473
## 1651:   DV not NA in dosing recs    MDV 1483
## 1652:   DV not NA in dosing recs    MDV 1493
\end{verbatim}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{What to do when Nonmem results seem meaningless}
\protect\hypertarget{what-to-do-when-nonmem-results-seem-meaningless}{}
\begin{columns}[T]
\begin{column}{0.85\textwidth}
Check of usual suspect: \texttt{\$DATA}
\end{column}

\begin{column}{0.15\textwidth}
\includegraphics[width=.5in]{figures/worksign.png}
\end{column}
\end{columns}

\begin{itemize}
\tightlist
\item
  NMscanData will check modification times of input and output, and give
  warnings if the model seems to have been edited since last model run.
\item
  Even with these checks, there is a risk that the column names given in
  \texttt{\$DATA} are wrong even if the estimation runs smoothly

  \begin{itemize}
  \tightlist
  \item
    either actually, because column used for estimation are not affected
  \item
    or apparently, because the wrong column labeling still gives a valid
    but nonsense dataset
  \end{itemize}
\item
  NMscanData already contains the functionality to provide a table input
  data column names, control stream column name specification, and
  resulting translation.
\item
  Todo: a simple function (or function argument to say
  \texttt{NMscanInput}) that returns this info.
\item
  A more advanced idea is some automated guessing if mistakes were made.
  This is currently not on the todo list.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{NMfreezeModels}
\protect\hypertarget{nmfreezemodels}{}
\begin{columns}[T]
\begin{column}{0.85\textwidth}
In order to ensure reproducibility, any output has to be produced based
on arvhived/frozen Nonmem models.
\end{column}

\begin{column}{0.15\textwidth}
\includegraphics[width=.5in]{figures/worksign.png}
\end{column}
\end{columns}

The components that need to be ``frozen'' are

\begin{itemize}
\tightlist
\item
  Nonmem control streams
\item
  input data
\item
  estimation results (output tables, .lst, .ext etc.)
\item
  simulation code (say mrgsolve scripts)
\item
  ?
\end{itemize}

\texttt{NMfreezeModels} does freeze

\begin{itemize}
\tightlist
\item
  input control streams
\item
  input data
\item
  all output tables
\item
  all nonmem results files
\end{itemize}

Limitations

\begin{itemize}
\tightlist
\item
  NMfreezeModels does not provide a solution for the simulation code at
  this point. I am very interested in how we can do this.
\item
  Only supports collections of models with one common input dataset
\item
  The permissions of the frozen folder should be read-only. However,
  that means that once the freeze it's done, you can no longer add code
  or descriptions. It all has to be handled in the freeze procedure.
\end{itemize}
\end{frame}

\begin{frame}{Safe model reader}
\protect\hypertarget{safe-model-reader}{}
\begin{columns}[T]
\begin{column}{0.85\textwidth}
A function to read frozen Nonmem results and mrgsolve code to ensure
that the right simulation model and parameter values are used
\end{column}

\begin{column}{0.15\textwidth}
\includegraphics[width=.5in]{figures/ideabulb.jpg}
\end{column}
\end{columns}

Obviously, this is closely related to the way mrgsolve code is frozen
together with nonmem code.
\end{frame}

\end{document}
